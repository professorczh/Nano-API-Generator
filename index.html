<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üçå Nano Generator</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23FFD700' d='M12 2C8.5 2 5.5 4.5 4.5 8c-.5 2 .5 4 2 5.5 0 1.5-1 2.5-1.5 4 0 2.5 2 4.5 4.5 4.5 1.5 0 2.5-.5 3.5-1.5.5 1.5.5 3.5 1.5 5.5 0 2-1 3.5-2.5 4-1.5.5-3.5 0-5-1.5-2-3.5-2-5 0-2 1-3.5 2.5-4.5-.5-1.5-.5-3.5-.5-5.5 0-1.5.5-2.5 1.5-3.5-.5-1-1.5-1.5-3-1.5-2 0-3.5 1-4.5 3z'/%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="panzoom.min.js"></script>
    <style>
        :root {
            --canvas-node-max-width: 300px;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(230, 230, 230, 1);
        }
        .image-card {
            position: relative;
            height: 120px;
            overflow: hidden;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .image-card img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            cursor: pointer;
        }
        .image-card .delete-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 24px;
            height: 24px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 16px;
            line-height: 1;
            z-index: 10;
        }
        .image-card:hover .delete-btn {
            opacity: 1;
        }
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #2563eb;
            border-radius: 50%;
            cursor: pointer;
        }
        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #2563eb;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }
        .image-response-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .canvas-node {
            position: absolute;
            cursor: grab;
            transition: box-shadow 0.2s;
            pointer-events: auto;
        }
        .canvas-node:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .canvas-node.selected {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5), 0 0 15px rgba(59, 130, 246, 0.3);
            outline: 2px solid #3b82f6;
            transform: translateZ(0);
        }
        .canvas-node img {
            display: block;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            max-width: var(--canvas-node-max-width);
            max-height: 300px;
        }
        .canvas-node.text-node {
            background: white;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            min-width: 200px;
            max-width: 400px;
        }
        .canvas-node.text-node .text-content {
            padding: 16px;
            font-size: 14px;
            line-height: 1.6;
            color: #374151;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .canvas-node.text-node .text-prompt {
            padding: 12px 16px;
            background: #f3f4f6;
            border-bottom: 1px solid #e5e7eb;
            font-size: 12px;
            color: #6b7280;
            border-radius: 12px 12px 0 0;
        }
        .canvas-node .node-info {
            position: absolute;
            bottom: -40px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 8px;
            color: #6b7280;
            white-space: normal;
            max-width: 300px;
            line-height: 1.3;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transition: all 0.2s ease;
        }

        .canvas-node:hover .node-info {
            opacity: 1;
        }
        .canvas-node .node-header {
            position: absolute;
            top: -35px;
            left: 0;
            right: 0;
            display: none;
            justify-content: space-between;
            align-items: center;
            pointer-events: none;
        }
        .canvas-node .node-toolbar {
            position: absolute;
            top: 50%;
            right: -60px;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(229, 231, 235, 0.8);
            border-radius: 8px;
            padding: 6px;
            display: none;
            flex-direction: column;
            gap: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 100;
        }
        .canvas-node.selected .node-toolbar {
            display: flex;
        }
        .canvas-node .node-center-coords {
            position: absolute;
            bottom: -25px;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 4px;
            z-index: 99;
            display: none;
        }
        .canvas-node .toolbar-btn {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 4px;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .canvas-node .toolbar-btn:hover {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }
        .canvas-node.selected .node-header {
            display: flex;
        }
        .canvas-node .node-filename {
            background: rgba(255, 255, 255, 0.95);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .canvas-node .node-resolution {
            background: rgba(255, 255, 255, 0.95);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .canvas-node .resize-handle {
            position: absolute;
            bottom: -8px;
            right: -8px;
            width: 16px;
            height: 16px;
            background: #3b82f6;
            border: 2px solid white;
            border-radius: 50%;
            cursor: nwse-resize;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
        }
        .canvas-node.selected .resize-handle {
            opacity: 1;
        }
        .pin-marker {
            position: absolute;
            width: 24px;
            height: 24px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            z-index: 20;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s;
        }
        .pin-marker:hover {
            transform: scale(1.2);
        }
        .pin-marker .pin-delete {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 14px;
            height: 14px;
            background: #1f2937;
            color: white;
            border-radius: 50%;
            font-size: 10px;
            line-height: 14px;
            text-align: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .pin-marker:hover .pin-delete {
            opacity: 1;
        }
        .pinned-image-tag {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 4px 8px;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 12px;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
            height: 32px;
            vertical-align: middle;
            margin: 0 2px;
            position: relative;
        }
        .pinned-image-tag:hover {
            background: #e5e7eb;
            border-color: #d1d5db;
        }
        .pinned-image-tag .pin-number {
            width: 18px;
            height: 18px;
            background: #f59e0b;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }
        .pinned-image-tag .tag-delete {
            display: none;
            width: 16px;
            height: 16px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            font-size: 10px;
            line-height: 16px;
            text-align: center;
            cursor: pointer;
            margin-left: 4px;
        }
        .pinned-image-tag:hover .tag-delete {
            display: block;
        }
        @keyframes pinZoom {
            0% {
                transform: scale(3);
                opacity: 0;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        .pasted-image-item {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 4px 8px;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 12px;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
            height: 32px;
            vertical-align: middle;
            margin: 0 2px;
            position: relative;
        }
        #promptInput:empty:before {
            content: attr(data-placeholder);
            color: #9ca3af;
            pointer-events: none;
        }
        #promptInput:focus {
            outline: none;
        }
        .pasted-image-item:hover {
            background: #e5e7eb;
            border-color: #d1d5db;
        }
        .pasted-image-item img {
            width: 24px;
            height: 24px;
            object-fit: cover;
            border-radius: 4px;
        }
        .pasted-image-item .delete-btn {
            display: none;
            width: 16px;
            height: 16px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            font-size: 10px;
            line-height: 16px;
            text-align: center;
            cursor: pointer;
            margin-left: 4px;
        }
        .pasted-image-item:hover .delete-btn {
            display: block;
        }
        
        .image-preview-tooltip {
            position: fixed;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            z-index: 100000;
            display: none;
            pointer-events: none;
            max-width: 800px;
            max-height: 800px;
            overflow: visible;
        }
        .image-preview-tooltip img {
            width: auto;
            height: auto;
            min-width: 100px;
            min-height: 100px;
            max-width: 800px;
            max-height: 800px;
            display: block;
            border-radius: 4px;
            object-fit: contain;
        }
        .image-preview-tooltip .pin-indicator {
            position: absolute;
            width: 24px;
            height: 24px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transform: translate(-50%, -50%);
        }
        
        #canvasViewport {
            cursor: default;
        }
        #canvas {
            background-color: #f9fafb;
            background-image: radial-gradient(circle, #d1d5db 1px, transparent 1px);
            background-size: 20px 20px;
            cursor: default;
        }

        .context-menu {
            position: fixed;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            padding: 8px 0;
            min-width: 150px;
        }

        .context-menu-item {
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            color: #374151;
            transition: background-color 0.15s ease;
        }

        .context-menu-item:hover {
            background-color: #f3f4f6;
        }

        .context-menu-item:active {
            background-color: #e5e7eb;
        }

        .loading-placeholder {
            position: absolute;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .loading-placeholder::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.3), transparent);
            animation: slide 1.5s infinite;
        }

        @keyframes slide {
            0% {
                left: -100%;
            }
            100% {
                left: 100%;
            }
        }

        .loading-placeholder .loading-text {
            position: relative;
            z-index: 1;
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
        }
        
        .text-loading-placeholder {
            position: absolute;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            min-width: 200px;
            max-width: 400px;
            min-height: 100px;
        }
        
        .text-loading-placeholder::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
            animation: slide 1.5s infinite;
        }
        
        .text-loading-placeholder .loading-text {
            position: relative;
            z-index: 1;
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
        }

        .debug-console {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #1e293b;
            border-top: 2px solid #3b82f6;
            z-index: 10001;
            transition: transform 0.3s ease;
        }

        .debug-console.collapsed {
            transform: translateY(calc(100% - 24px));
        }

        .debug-console-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 16px;
            background: #0f172a;
            cursor: pointer;
            user-select: none;
            height: 24px;
            min-height: 24px;
        }

        .debug-console-title {
            color: #e2e8f0;
            font-size: 14px;
            font-weight: 600;
        }

        .debug-console-toggle {
            color: #94a3b8;
            font-size: 12px;
            transition: transform 0.3s ease;
        }

        .debug-console.collapsed .debug-console-toggle {
            transform: rotate(180deg);
        }

        .debug-console-content {
            height: 300px;
            overflow-y: auto;
            padding: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            scrollbar-width: thin;
            scrollbar-color: #4b5563 #1f2937;
            display: flex;
            flex-direction: column;
        }

        .debug-console-content::-webkit-scrollbar {
            width: 8px;
        }

        .debug-console-content::-webkit-scrollbar-track {
            background: #1f2937;
            border-radius: 4px;
        }

        .debug-console-content::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }

        .debug-console-content::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        .debug-log {
            padding: 4px 8px;
            margin-bottom: 4px;
            border-radius: 4px;
            word-wrap: break-word;
        }

        .debug-log.info {
            background: #1e40af;
            color: #dbeafe;
        }

        .debug-log.success {
            background: #065f46;
            color: #d1fae5;
        }

        .debug-log.warning {
            background: #92400e;
            color: #fef3c7;
        }

        .debug-log.error {
            background: #991b1b;
            color: #fecaca;
        }

        .debug-log.event {
            background: #374151;
            color: #e5e7eb;
        }

        .debug-log .timestamp {
            color: #9ca3af;
            margin-right: 8px;
        }

        .debug-log .message {
            color: inherit;
        }
        
        .debug-log-copy {
            margin-left: 8px;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
            font-size: 14px;
            user-select: none;
        }
        
        .debug-log-copy:hover {
            opacity: 1;
        }

        .debug-console-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: #0f172a;
            border-top: 1px solid #1f2937;
        }
        
        .debug-console-footer-left {
            display: flex;
            align-items: center;
        }
        
        .debug-console-footer-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .debug-console-clear {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
            margin-right: 8px;
        }

        .debug-console-clear:hover {
            background: #2563eb;
        }

        .debug-console-mouse-label {
            display: flex;
            align-items: center;
            gap: 6px;
            color: white;
            font-size: 12px;
            cursor: pointer;
            user-select: none;
        }

        .debug-console-mouse-checkbox {
            width: 14px;
            height: 14px;
            cursor: pointer;
            accent-color: #3b82f6;
        }

        .ui-panel-draggable {
            cursor: move;
            user-select: none;
        }

        .ui-panel-draggable:active {
            cursor: grabbing;
        }

        .minimap-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }

        .minimap-header {
            background: #f3f4f6;
            padding: 6px 12px;
            border-bottom: 1px solid #e5e7eb;
        }

        .minimap-title {
            font-size: 12px;
            font-weight: 600;
            color: #374151;
        }

        .minimap-content {
            padding: 8px;
        }

        .minimap-canvas {
            width: 200px;
            height: 200px;
            background-color: #f9fafb;
            background-image: radial-gradient(circle, #d1d5db 1px, transparent 1px);
            background-size: 4px 4px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }

        .minimap-viewport {
            position: absolute;
            border: 2px solid #2563eb;
            background-color: rgba(37, 99, 235, 0.1);
            pointer-events: auto;
            cursor: move;
            z-index: 2;
        }

        .minimap-viewport:hover {
            border-color: #1d4ed8;
            background-color: rgba(29, 78, 216, 0.15);
        }

        .zoom-control-content {
            padding: 8px;
        }

        .zoom-buttons {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .zoom-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
            background: white;
            color: #374151;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .zoom-btn:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }

        .zoom-btn:active {
            background: #e5e7eb;
            transform: scale(0.95);
        }

        .zoom-slider-container {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .zoom-slider {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: #e5e7eb;
            outline: none;
            cursor: pointer;
        }

        .zoom-slider::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .zoom-slider::-moz-range-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .zoom-slider::-webkit-slider-runnable-track {
            background: #d1d5db;
            border-radius: 3px;
        }

        .zoom-slider::-moz-range-track {
            background: #d1d5db;
            border-radius: 3px;
        }

        .zoom-value {
            font-size: 12px;
            font-weight: 600;
            color: #374151;
            min-width: 42px;
            text-align: center;
            cursor: pointer;
            padding: 4px 6px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .zoom-value:hover {
            background: #f3f4f6;
            color: #3b82f6;
        }

        .zoom-reset-btn {
            display: none;
        }

        .toolbar-upload-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);
            border: 3px solid white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .toolbar-upload-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
        }

        .toolbar-upload-btn:active {
            transform: scale(0.95);
        }

        .toolbar-icon {
            font-size: 32px;
            font-weight: 300;
            color: white;
            line-height: 1;
            display: inline-block;
            vertical-align: middle;
        }

        .minimap-image {
            position: absolute;
            background: #10b981;
            border: 1px solid #059669;
            border-radius: 2px;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen text-gray-800 overflow-hidden">

    <!-- ÂÖ®Â±èÁîªÂ∏ÉÂ±Ç -->
    <div id="canvasLayer" class="fixed inset-0 z-0">
        <div id="canvasViewport" class="w-full h-full">
            <div id="canvas" class="absolute origin-center transition-transform duration-75 ease-out" style="width: 10000px; height: 10000px; left: 0px; top: 0px;">
                <!-- Ë∞ÉËØïÁΩëÊ†º -->
                <div id="debugGrid" class="absolute inset-0 pointer-events-none hidden">
                    <svg width="10000" height="10000" viewBox="0 0 10000 10000" xmlns="http://www.w3.org/2000/svg" id="debugGridSvg">
                    </svg>
                </div>
                <div id="responseOutput" class="whitespace-pre-wrap text-gray-700 leading-relaxed italic text-gray-400 p-4">
                    ÂÜÖÂÆπÂ∞ÜÂú®Ê≠§Â§ÑÊòæÁ§∫...
                </div>
                <div id="imageResponseContainer">
                </div>
            </div>
        </div>
    </div>

    <!-- UIÊÇ¨ÊµÆÂ±Ç -->
    <div id="uiLayer" class="fixed inset-0 z-10 pointer-events-none">
        <!-- Ê†áÈ¢ò -->
        <header class="pointer-events-auto absolute top-4 left-4 flex items-center gap-3">
            <img src="logo.svg" alt="Nano Generator Logo" class="w-12 h-12">
            <h1 class="text-2xl font-bold text-gray-900">Nano Generator</h1>
        </header>

        <!-- ÂèØÊãñÂä®ÁöÑUIÈù¢Êùø -->
        <div id="uiPanel" class="pointer-events-auto absolute top-16 right-4 w-[400px] max-w-[90vw] max-h-[calc(100vh-80px)] overflow-y-auto">
            <div class="glass-card rounded-2xl p-6 shadow-sm mb-4">
                <div class="flex items-center justify-between mb-2">
                    <label class="block text-sm font-medium text-gray-700">API Key</label>
                    <div class="flex items-center gap-2">
                        <a href="https://aistudio.google.com/api-keys" target="_blank" class="text-xs text-blue-600 hover:text-blue-700 underline">Ëé∑Âèñ API Key</a>
                        <button id="toggleApiKeyPanel" class="text-sm text-blue-600 hover:text-blue-700">ÊäòÂè†</button>
                    </div>
                </div>
                <div id="apiKeyPanel">
                        <div class="flex gap-3">
                            <input type="text" id="apiKeyInput" 
                                class="flex-1 p-4 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all"
                                placeholder="ËæìÂÖ•‰Ω†ÁöÑ API Key">
                            <button id="testApiKeyBtn" 
                                class="bg-gray-600 hover:bg-gray-700 text-white px-5 py-2.5 rounded-lg font-medium transition-colors shadow-sm flex items-center gap-2 whitespace-nowrap">
                                <span>ÊµãËØï</span>
                                <div id="testLoader" class="hidden animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full"></div>
                            </button>
                        </div>
                        <div id="apiStatus" class="mt-2 text-sm text-gray-500"></div>
                        
                        <div class="mt-3 flex gap-3">
                            <button id="saveApiKeyBtn" 
                                class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors shadow-sm text-sm">
                                Â≠òÂÇ® API
                            </button>
                            <button id="clearApiKeyBtn" 
                                class="flex-1 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition-colors shadow-sm text-sm">
                                Ê∏ÖÈô§ API
                            </button>
                        </div>
                        
                        <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-500 mb-1">ÊñáÊú¨Ê®°Âûã</label>
                                <select id="textModelName" 
                                    class="w-full px-3 py-2 rounded-lg border border-gray-200 bg-white text-gray-700 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all">
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500 mb-1">ËØÜÂõæÊ®°Âûã</label>
                                <select id="visionModelName" 
                                    class="w-full px-3 py-2 rounded-lg border border-gray-200 bg-white text-gray-700 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all">
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500 mb-1">ÁîüÂõæÊ®°Âûã</label>
                                <select id="imageModelName" 
                                    class="w-full px-3 py-2 rounded-lg border border-gray-200 bg-white text-gray-700 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all">
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="glass-card rounded-2xl p-6 shadow-sm">
                    <div class="flex items-center justify-between mb-2">
                        <label class="block text-sm font-medium text-gray-700">ÊèêÁ§∫ËØç</label>
                        <button id="togglePromptPanel" class="text-sm text-blue-600 hover:text-blue-700">ÊäòÂè†</button>
                    </div>
                    <div id="promptPanel">
                        <div id="promptContainer" class="w-full p-4 rounded-xl border border-gray-200 focus-within:ring-2 focus-within:ring-blue-500 focus-within:border-transparent outline-none transition-all bg-white min-h-[120px]">
                            <div id="promptInput" contenteditable="true" 
                                class="w-full border-none outline-none resize-none bg-transparent text-gray-700 placeholder-gray-400 whitespace-pre-wrap"
                                data-placeholder="ËØ∑ËæìÂÖ•ÊèêÁ§∫ËØç"></div>
                        </div>
                        
                        <div class="mt-4 flex justify-between items-center">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="imageGenMode" class="w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                                <span class="text-gray-700 font-medium">ÁîüÂõæÊ®°Âºè</span>
                            </label>
                            <div class="flex items-center gap-3">
                                <span id="statusTag" class="text-xs px-2 py-1 rounded bg-gray-50 text-gray-600">Â∞±Áª™</span>
                                <button id="sendBtn" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-lg font-medium transition-colors shadow-sm flex items-center gap-2">
                                    <span>ÂèëÈÄÅ</span>
                                    <div id="loader" class="hidden animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full"></div>
                                </button>
                            </div>
                        </div>

                        <div id="imageGenOptions" class="mt-4">
                            <div class="border-t border-gray-200 pt-4">
                                <h3 class="text-sm font-semibold text-gray-700 mb-3">ÁîüÂõæÂèÇÊï∞ËÆæÁΩÆ</h3>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">ÂÆΩÈ´òÊØî</label>
                                        <select id="aspectRatio"
                                            class="w-full px-3 py-2 rounded-lg border border-gray-200 bg-white text-gray-700 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all">
                                            <option value="1:1" selected>1:1 Ê≠£ÊñπÂΩ¢</option>
                                            <option value="16:9">16:9 ÂÆΩÂ±è</option>
                                            <option value="9:16">9:16 Á´ñÂ±è</option>
                                            <option value="21:9">21:9 Ë∂ÖÂÆΩÂ±è</option>
                                            <option value="4:3">4:3 ‰º†ÁªüÊ®™Âêë</option>
                                            <option value="3:4">3:4 ‰º†ÁªüÁ´ñÂêë</option>
                                            <option value="3:2">3:2 ÁªèÂÖ∏Ê®™Âêë</option>
                                            <option value="2:3">2:3 ÁªèÂÖ∏Á´ñÂêë</option>
                                            <option value="5:4">5:4 Â§ßÁîªÂπÖÊ®™Âêë</option>
                                            <option value="4:5">4:5 Â§ßÁîªÂπÖÁ´ñÂêë</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">ÂàÜËæ®Áéá</label>
                                        <select id="imageSize" 
                                            class="w-full px-3 py-2 rounded-lg border border-gray-200 bg-white text-gray-700 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all">
                                            <option value="1K" selected>1K (1024px)</option>
                                            <option value="2K">2K È´òÊ∏Ö</option>
                                            <option value="4K">4K Ë∂ÖÈ´òÊ∏Ö</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            Ê∏©Â∫¶: <span id="temperatureValue">0.6</span>
                                        </label>
                                        <input type="range" id="temperature" min="0" max="1" step="0.1" value="0.6" 
                                            class="w-full">
                                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                                            <span>Á°ÆÂÆöÊÄß</span>
                                            <span>ÂàõÈÄ†ÊÄß</span>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            Top-P: <span id="topPValue">0.95</span>
                                        </label>
                                        <input type="range" id="topP" min="0" max="1" step="0.05" value="0.95" 
                                            class="w-full">
                                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                                            <span>ÈõÜ‰∏≠</span>
                                            <span>Â§öÊ†∑</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ë∞ÉËØïÊéßÂà∂Âè∞ -->
        <div id="debugConsole" class="debug-console collapsed pointer-events-auto">
            <div class="debug-console-header">
                <span class="debug-console-title">Ë∞ÉËØïÊéßÂà∂Âè∞Èù¢Êùø</span>
                <span class="debug-console-toggle">‚ñº</span>
            </div>
            <div class="debug-console-content" id="debugConsoleContent">
            </div>
            <div class="debug-console-footer">
                <div class="debug-console-footer-left">
                    <label class="debug-console-mouse-label">
                        <input type="checkbox" id="debugConsoleToggleMouse" class="debug-console-mouse-checkbox">
                        <span>ÊòæÁ§∫Èº†Ê†áÊó•Âøó</span>
                    </label>
                </div>
                <div class="debug-console-footer-right">
                    <button class="debug-console-clear" id="debugConsoleClear">Ê∏ÖÁ©∫</button>
                    <label class="debug-console-mouse-label">
                        <input type="checkbox" id="debugConsoleToggleMarker" class="debug-console-mouse-checkbox">
                        <span>‰∏≠ÂøÉÊ†áËÆ∞</span>
                    </label>
                    <label class="debug-console-mouse-label">
                        <input type="checkbox" id="debugConsoleToggleCoords" class="debug-console-mouse-checkbox">
                        <span>ÂõæÁâáÂùêÊ†á</span>
                    </label>
                    <label class="debug-console-mouse-label">
                        <input type="checkbox" id="debugConsoleToggleGrid" class="debug-console-mouse-checkbox">
                        <span>Ë∞ÉËØïÁΩëÊ†º</span>
                    </label>
                    <label class="debug-console-mouse-label">
                        <input type="checkbox" id="debugConsoleToggleSample" class="debug-console-mouse-checkbox">
                        <span>Ê†∑‰æãÂõæÁâá</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- ÁîªÂ∏ÉÁº©Áï•Âõæ -->
        <div id="canvasMinimap" class="fixed bottom-32 left-4 z-20 pointer-events-auto">
            <div class="minimap-container">
                <div class="minimap-header">
                    <span class="minimap-title">ÁîªÂ∏ÉÂØºËà™</span>
                </div>
                <div id="minimapContent" class="minimap-content">
                    <div id="minimapCanvas" class="minimap-canvas">
                        <div id="minimapViewport" class="minimap-viewport"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÁîªÂ∏ÉÁº©ÊîæÊéßÂà∂ -->
        <div id="canvasZoomControl" class="fixed bottom-96 left-4 z-20 pointer-events-auto">
            <div class="minimap-container">
                <div class="minimap-header">
                    <span class="minimap-title">ÁîªÂ∏ÉÁº©Êîæ</span>
                </div>
                <div class="zoom-control-content">
                    <div class="zoom-buttons">
                        <button id="zoomOutBtn" class="zoom-btn" title="Áº©Â∞è (Ctrl+-)">‚àí</button>
                        <div class="zoom-slider-container">
                            <input type="range" id="zoomSlider" class="zoom-slider" min="50" max="250" step="25" value="100">
                        </div>
                        <span id="zoomValue" class="zoom-value" title="ÁÇπÂáªÈáçÁΩÆ‰∏∫100%">100%</span>
                        <button id="zoomInBtn" class="zoom-btn" title="ÊîæÂ§ß (Ctrl+=)">+</button>
                        <button id="zoomResetBtn" class="zoom-btn" title="ÈáçÁΩÆÁº©Êîæ">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                                <path d="M3 3v5h5"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ëø∑‰Ω†Â∑•ÂÖ∑Ê†è -->
        <div id="miniToolbar" class="fixed bottom-16 left-1/2 transform -translate-x-1/2 z-20 pointer-events-auto">
            <button id="uploadImageBtn" class="toolbar-upload-btn">
                <svg class="toolbar-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
            </button>
            <input type="file" id="imageUploadInput" accept="image/*" class="hidden">
        </div>
        
        <!-- ÁîªÂ∏É‰∏≠ÂøÉÊ†áËÆ∞ -->
        <div id="canvasCenterMarker" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-30 pointer-events-none">
            <div class="w-2 h-2 bg-red-500 rounded-full"></div>
            <div class="text-xs text-red-500 mt-2 whitespace-nowrap">‰∏≠ÂøÉÂùêÊ†á: ËÆ°ÁÆó‰∏≠...</div>
        </div>
    </div>

    <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-90 hidden items-center justify-center z-[1000] p-4">
        <div class="bg-white rounded-2xl p-6 max-w-[95vw] max-h-[95vh] w-full shadow-2xl flex flex-col">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h3 class="text-lg font-semibold text-gray-900">ÂõæÁâáÈ¢ÑËßà</h3>
                <button id="closeModalBtn" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <div class="flex justify-center mb-6 flex-grow overflow-auto">
                <img id="modalImage" class="max-w-full max-h-[75vh] rounded-lg object-contain" alt="È¢ÑËßàÂõæÁâá">
            </div>
            <div class="flex justify-end gap-3 flex-shrink-0">
                <button id="openFolderBtn" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors">ÊâìÂºÄÊñá‰ª∂Â§π</button>
                <button id="closeModalBtn2" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors">ÂÖ≥Èó≠</button>
                <button id="downloadModalBtn" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition-colors">‰∏ãËΩΩ</button>
            </div>
        </div>
    </div>

    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[1100] p-4">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full shadow-2xl">
            <div class="flex items-center mb-4">
                <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center mr-3">
                    <span class="text-red-600 text-xl">‚ö†Ô∏è</span>
                </div>
                <h3 class="text-lg font-semibold text-gray-900">Á°ÆËÆ§Âà†Èô§</h3>
            </div>
            <p class="text-gray-600 mb-4" id="confirmModalMessage">Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÂº†ÂõæÁâáÂêóÔºü</p>
            <div class="flex items-center mb-6">
                <input type="checkbox" id="confirmModalCheckbox" class="w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500">
                <label for="confirmModalCheckbox" class="ml-2 text-sm text-gray-600">‰∏çÂÜçÊèêÈÜí</label>
            </div>
            <div class="flex justify-end gap-3">
                <button id="confirmModalCancel" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors">ÂèñÊ∂à</button>
                <button id="confirmModalOk" class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 transition-colors">Âà†Èô§</button>
            </div>
        </div>
    </div>

    <script type="importmap">
    {
      "imports": {
        "@google/generative-ai": "https://esm.run/@google/generative-ai"
      }
    }
    </script>
    
    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";
        import { CONFIG, TEXT_MODELS, IMAGE_MODELS } from "./config.js";

        const sendBtn = document.getElementById('sendBtn');
        const promptInput = document.getElementById('promptInput');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const responseOutput = document.getElementById('responseOutput');
        const loader = document.getElementById('loader');
        const statusTag = document.getElementById('statusTag');
        const testApiKeyBtn = document.getElementById('testApiKeyBtn');
        const testLoader = document.getElementById('testLoader');
        const apiStatus = document.getElementById('apiStatus');
        const imageGenMode = document.getElementById('imageGenMode');
        const imageGenOptions = document.getElementById('imageGenOptions');
        const aspectRatio = document.getElementById('aspectRatio');
        const imageSize = document.getElementById('imageSize');
        const temperature = document.getElementById('temperature');
        const topP = document.getElementById('topP');
        const temperatureValue = document.getElementById('temperatureValue');
        const topPValue = document.getElementById('topPValue');
        const imageResponseContainer = document.getElementById('imageResponseContainer');
        const textModelName = document.getElementById('textModelName');
        const visionModelName = document.getElementById('visionModelName');
        const imageModelName = document.getElementById('imageModelName');
        const imageModal = document.getElementById('imageModal');
        
        let activeRequests = 0;
        const modalImage = document.getElementById('modalImage');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const closeModalBtn2 = document.getElementById('closeModalBtn2');
        const downloadModalBtn = document.getElementById('downloadModalBtn');
        const openFolderBtn = document.getElementById('openFolderBtn');
        const toggleApiKeyPanel = document.getElementById('toggleApiKeyPanel');
        const togglePromptPanel = document.getElementById('togglePromptPanel');
        const apiKeyPanel = document.getElementById('apiKeyPanel');
        const promptPanel = document.getElementById('promptPanel');
        const canvasViewport = document.getElementById('canvasViewport');
        const canvas = document.getElementById('canvas');
        const resetCanvasBtn = document.getElementById('resetCanvasBtn');
        const debugConsole = document.getElementById('debugConsole');
        const debugConsoleContent = document.getElementById('debugConsoleContent');
        const debugConsoleClear = document.getElementById('debugConsoleClear');
        const debugConsoleHeader = document.querySelector('.debug-console-header');
        const uiPanel = document.getElementById('uiPanel');
        const canvasMinimap = document.getElementById('canvasMinimap');
        const minimapCanvas = document.getElementById('minimapCanvas');
        const minimapViewport = document.getElementById('minimapViewport');
        const uploadImageBtn = document.getElementById('uploadImageBtn');
        const imageUploadInput = document.getElementById('imageUploadInput');
        const canvasZoomControl = document.getElementById('canvasZoomControl');
        const zoomSlider = document.getElementById('zoomSlider');
        const zoomValue = document.getElementById('zoomValue');
        const zoomOutBtn = document.getElementById('zoomOutBtn');
        const zoomInBtn = document.getElementById('zoomInBtn');
        const zoomResetBtn = document.getElementById('zoomResetBtn');
        
        let showMouseLogs = false;
        let currentBlobUrl = null;
        let panzoom = null;
        let selectedNode = null;
        let nodeCounter = 0;
        let pinCounter = 0;
        let imagePins = new Map();
        let isDraggingUIPanel = false;
        let uiPanelStartX = 0;
        let uiPanelStartY = 0;
        let uiPanelStartLeft = 0;
        let uiPanelStartTop = 0;
        let isDraggingMinimapViewport = false;
        let minimapDragStartX = 0;
        let minimapDragStartY = 0;
        let minimapPanStartX = 0;
        let minimapPanStartY = 0;
        // Â∫îÁî®Áä∂ÊÄÅÁÆ°ÁêÜ
        const AppState = {
            mode: 'VIEW', // VIEW, DRAGGING_NODE, SELECTING_AREA
            activeNode: null,
            scale: 1,
            isDraggingNode: false,
            dragNode: null,
            dragStartX: 0,
            dragStartY: 0,
            dragNodeStartLeft: 0,
            dragNodeStartTop: 0,
            isMiddleMouseDown: false,
            lastMouseX: 0,
            lastMouseY: 0,
            panX: 0,
            panY: 0,
            isResizingNode: false,
            resizeStart: { x: 0, y: 0, width: 0, height: 0 },
            resizeNode: null,
            // ‰ΩøÁî® Map Â≠òÂÇ®ËäÇÁÇπÊï∞ÊçÆÔºåÊñπ‰æøÂêéÊúüÂêåÊ≠•Âà∞ÂêéÁ´Ø
            nodes: new Map(),
            
            // Êõ¥Êñ∞Áº©ÊîæÊØî‰æã
            updateScale: function(newScale) {
                this.scale = newScale;
                if (showMouseLogs) {
                    debugLog(`[Áä∂ÊÄÅÊõ¥Êñ∞] Áº©ÊîæÊØî‰æã: ${newScale}`, 'info');
                }
            },
            
            // ÈáçÁΩÆÁä∂ÊÄÅ
            reset: function() {
                this.mode = 'VIEW';
                this.activeNode = null;
                this.isDraggingNode = false;
                this.dragNode = null;
                this.isMiddleMouseDown = false;
                this.isResizingNode = false;
                this.resizeNode = null;
            }
        };

        function debugLog(message, type = 'info') {
            const logEntry = document.createElement('div');
            logEntry.className = `debug-log ${type}`;
            
            const timestamp = document.createElement('span');
            timestamp.className = 'timestamp';
            const now = new Date();
            timestamp.textContent = `[${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}.${now.getMilliseconds().toString().padStart(3, '0')}]`;
            
            const messageSpan = document.createElement('span');
            messageSpan.className = 'message';
            messageSpan.textContent = message;
            
            const copyIcon = document.createElement('span');
            copyIcon.className = 'debug-log-copy';
            copyIcon.innerHTML = 'üìã';
            copyIcon.title = 'Â§çÂà∂';
            copyIcon.addEventListener('click', (e) => {
                e.stopPropagation();
                navigator.clipboard.writeText(message).then(() => {
                    copyIcon.textContent = '‚úì';
                    setTimeout(() => {
                        copyIcon.textContent = 'üìã';
                    }, 1000);
                });
            });
            
            logEntry.appendChild(timestamp);
            logEntry.appendChild(messageSpan);
            logEntry.appendChild(copyIcon);
            debugConsoleContent.appendChild(logEntry);
            debugConsoleContent.scrollTop = debugConsoleContent.scrollHeight;
            
            const maxLogs = 100;
            const logs = debugConsoleContent.querySelectorAll('.debug-log');
            if (logs.length > maxLogs) {
                for (let i = 0; i < logs.length - maxLogs; i++) {
                    logs[i].remove();
                }
            }
        }

        debugConsoleHeader.addEventListener('click', () => {
            debugConsole.classList.toggle('collapsed');
        });

        debugConsoleClear.addEventListener('click', (e) => {
            e.stopPropagation();
            const logs = debugConsoleContent.querySelectorAll('.debug-log');
            logs.forEach(log => log.remove());
        });

        const debugConsoleToggleMarker = document.getElementById('debugConsoleToggleMarker');
        const canvasCenterMarker = document.getElementById('canvasCenterMarker');
        
        canvasCenterMarker.classList.add('hidden');
        
        debugConsoleToggleMarker.addEventListener('change', (e) => {
            if (e.target.checked) {
                canvasCenterMarker.classList.remove('hidden');
            } else {
                canvasCenterMarker.classList.add('hidden');
            }
        });
        
        const debugConsoleToggleCoords = document.getElementById('debugConsoleToggleCoords');
        
        const allCoordsElements = document.querySelectorAll('.node-center-coords');
        allCoordsElements.forEach(element => {
            element.style.display = 'none';
        });
        
        debugConsoleToggleCoords.addEventListener('change', (e) => {
            const allCoordsElements = document.querySelectorAll('.node-center-coords');
            allCoordsElements.forEach(element => {
                if (e.target.checked) {
                    element.style.display = 'block';
                } else {
                    element.style.display = 'none';
                }
            });
        });
        
        const debugConsoleToggleGrid = document.getElementById('debugConsoleToggleGrid');
        const debugGrid = document.getElementById('debugGrid');
        
        debugGrid.classList.add('hidden');
        
        debugConsoleToggleGrid.addEventListener('change', (e) => {
            if (e.target.checked) {
                debugGrid.classList.remove('hidden');
            } else {
                debugGrid.classList.add('hidden');
            }
        });
        
        const debugConsoleToggleSample = document.getElementById('debugConsoleToggleSample');
        let sampleImageNode = null;
        
        debugConsoleToggleSample.addEventListener('change', (e) => {
            if (e.target.checked) {
                if (!sampleImageNode) {
                    sampleImageNode = imageResponseContainer.querySelector('[data-filename="sample_image.png"]');
                    if (!sampleImageNode) {
                        addSampleImage();
                        sampleImageNode = imageResponseContainer.querySelector('[data-filename="sample_image.png"]');
                    }
                }
                if (sampleImageNode) {
                    sampleImageNode.classList.remove('hidden');
                }
            } else {
                sampleImageNode = imageResponseContainer.querySelector('[data-filename="sample_image.png"]');
                if (sampleImageNode) {
                    sampleImageNode.classList.add('hidden');
                }
            }
        });
        
        const debugConsoleToggleMouse = document.getElementById('debugConsoleToggleMouse');
        
        debugConsoleToggleMouse.addEventListener('change', (e) => {
            showMouseLogs = e.target.checked;
            debugLog(`[Èº†Ê†áÊó•Âøó] ${showMouseLogs ? 'ÂêØÁî®' : 'Á¶ÅÁî®'}`, 'info');
        });

        function maskApiKey(apiKey) {
            if (!apiKey || apiKey.length < 6) return apiKey;
            return apiKey.substring(0, 3) + '*'.repeat(apiKey.length - 6) + apiKey.substring(apiKey.length - 3);
        }

        function updateApiKeyDisplay() {
            const apiKey = CONFIG.API_KEY;
            if (apiKey) {
                apiKeyInput.value = maskApiKey(apiKey);
            }
        }

        apiKeyInput.value = CONFIG.API_KEY ? maskApiKey(CONFIG.API_KEY) : '';

        apiKeyInput.addEventListener('focus', () => {
            apiKeyInput.value = CONFIG.API_KEY;
        });

        apiKeyInput.addEventListener('blur', () => {
            const newValue = apiKeyInput.value.trim();
            if (newValue && newValue !== maskApiKey(CONFIG.API_KEY)) {
                CONFIG.API_KEY = newValue;
            }
            updateApiKeyDisplay();
        });

        apiKeyInput.addEventListener('input', () => {
            const newValue = apiKeyInput.value.trim();
            if (newValue && !newValue.includes('*')) {
                CONFIG.API_KEY = newValue;
            }
        });

        toggleApiKeyPanel.addEventListener('click', () => {
            if (apiKeyPanel.classList.contains('hidden')) {
                apiKeyPanel.classList.remove('hidden');
                toggleApiKeyPanel.textContent = 'ÊäòÂè†';
            } else {
                apiKeyPanel.classList.add('hidden');
                toggleApiKeyPanel.textContent = 'Â±ïÂºÄ';
            }
        });

        togglePromptPanel.addEventListener('click', () => {
            if (promptPanel.classList.contains('hidden')) {
                promptPanel.classList.remove('hidden');
                togglePromptPanel.textContent = 'ÊäòÂè†';
            } else {
                promptPanel.classList.add('hidden');
                togglePromptPanel.textContent = 'Â±ïÂºÄ';
            }
        });

        // UIÈù¢ÊùøÊãñÂä®ÂäüËÉΩ
        uiPanel.addEventListener('mousedown', (e) => {
            const target = e.target;
            // ÊéíÈô§‰∫§‰∫íÂÖÉÁ¥†ÔºöÊåâÈíÆ„ÄÅËæìÂÖ•Ê°Ü„ÄÅÈÄâÊã©Ê°Ü„ÄÅcontenteditableÂÖÉÁ¥†„ÄÅÊªöÂä®Êù°
            const isInteractiveElement = target.closest('button') || 
                                       target.closest('input') || 
                                       target.closest('select') || 
                                       target.closest('textarea') ||
                                       target.closest('[contenteditable="true"]') ||
                                       target.closest('.debug-console-content');
            
            if (target.closest('.pointer-events-auto') && !isInteractiveElement) {
                isDraggingUIPanel = true;
                uiPanelStartX = e.clientX;
                uiPanelStartY = e.clientY;
                uiPanelStartLeft = parseInt(uiPanel.style.left) || parseInt(getComputedStyle(uiPanel).left);
                uiPanelStartTop = parseInt(uiPanel.style.top) || parseInt(getComputedStyle(uiPanel).top);
                uiPanel.classList.add('ui-panel-draggable');
                e.preventDefault();
            }
        });

        document.addEventListener('mousemove', (e) => {
            if (isDraggingUIPanel) {
                const deltaX = e.clientX - uiPanelStartX;
                const deltaY = e.clientY - uiPanelStartY;
                const newLeft = uiPanelStartLeft + deltaX;
                const newTop = uiPanelStartTop + deltaY;
                
                // ÈôêÂà∂Èù¢Êùø‰∏çË∂ÖÂá∫Â±èÂπïËæπÁïå
                const maxLeft = window.innerWidth - uiPanel.offsetWidth;
                const maxTop = window.innerHeight - uiPanel.offsetHeight;
                const clampedLeft = Math.max(0, Math.min(newLeft, maxLeft));
                const clampedTop = Math.max(0, Math.min(newTop, maxTop));
                
                uiPanel.style.left = `${clampedLeft}px`;
                uiPanel.style.top = `${clampedTop}px`;
            }
        });

        document.addEventListener('mouseup', () => {
            if (isDraggingUIPanel) {
                isDraggingUIPanel = false;
                uiPanel.classList.remove('ui-panel-draggable');
            }
        });

        function initCanvas() {
            console.log('Initializing canvas...');
            console.log('Canvas element:', canvas);
            console.log('CanvasViewport:', canvasViewport);
            
            if (typeof Panzoom === 'undefined') {
                console.error('Panzoom library not loaded');
                return;
            }
            
            // ËÆ°ÁÆóÂàùÂßã‰ΩçÁΩÆÔºåËÆ©ÁîªÂ∏É‰∏≠ÂøÉ(5000, 5000)ÂØπÂáÜËßÜÂè£‰∏≠ÂøÉ
            const uiPanel = document.getElementById('uiPanel');
            const uiPanelWidth = uiPanel ? uiPanel.offsetWidth : 400;
            const viewportWidth = window.innerWidth - uiPanelWidth;
            const viewportHeight = window.innerHeight;
            const startX = viewportWidth / 2 - 5000;
            const startY = viewportHeight / 2 - 5000;
            
            panzoom = Panzoom(canvas, {
                maxScale: 2.5,
                minScale: 0.5,
                step: 0.25,
                disablePan: false,
                disableZoom: false,
                excludeClass: 'canvas-node',
                canvas: true,
                noBind: false,
                startX: startX,
                startY: startY,
                setTransform: (el, { x, y, scale }) => {
                    el.style.transform = `translate(${x}px, ${y}px) scale(${scale})`;
                    
                    AppState.panX = x;
                    AppState.panY = y;
                    AppState.scale = scale;
                    
                    updateMinimapViewport();
                    updateCenterMarkerCoordinates();
                }
            });
            
            const scale = panzoom.getScale();
            AppState.updateScale(scale);
            AppState.panX = startX;
            AppState.panY = startY;
            
            // Á¥ßÊé•ÁùÄÊâãÂä®Ëß¶Âèë‰∏ÄÊ¨° UI Êõ¥Êñ∞
            setTimeout(() => {
                updateCenterMarkerCoordinates();
                updateMinimapViewport();
            }, 0);
            
            // ÁîüÊàêË∞ÉËØïÁΩëÊ†º
            generateDebugGrid();
            
            canvasViewport.style.cursor = 'default';
            canvas.style.cursor = 'default';
            
            // ÁõëÂê¨Áº©Êîæ‰∫ã‰ª∂ÔºåÂÆûÊó∂Êõ¥Êñ∞Áä∂ÊÄÅ
            canvas.addEventListener('panzoomzoom', (e) => {
                const newScale = e.detail.scale;
                AppState.updateScale(newScale);
                
                // ÂêåÊ≠•Êõ¥Êñ∞ÊªëÂùóÂíåÁº©ÊîæÂÄºÊòæÁ§∫
                zoomSlider.value = Math.round(newScale * 100);
                zoomValue.textContent = `${Math.round(newScale * 100)}%`;
                
                updateMinimapViewport();
                updateCenterMarkerCoordinates();
                if (!debugConsole.contains(e.target) && showMouseLogs) {
                    debugLog(`[Áº©Êîæ‰∫ã‰ª∂] Êñ∞Áº©ÊîæÊØî‰æã: ${newScale}`, 'event');
                }
            });
            
            // ÁõëÂê¨Âπ≥Áßª‰∫ã‰ª∂ÔºåÂÆûÊó∂Êõ¥Êñ∞ÂùêÊ†á
            canvas.addEventListener('panzoompan', (e) => {
                const panX = e.detail.x;
                const panY = e.detail.y;
                AppState.panX = panX;
                AppState.panY = panY;
                updateMinimapViewport();
                updateCenterMarkerCoordinates();
                if (!debugConsole.contains(e.target) && showMouseLogs) {
                    debugLog(`[Âπ≥Áßª‰∫ã‰ª∂] panX=${panX}, panY=${panY}`, 'event');
                }
            });
            
            canvasViewport.addEventListener('mousedown', (e) => {
                if (debugConsole.contains(e.target)) return;
                if (showMouseLogs) {
                    debugLog(`[Èº†Ê†áÊåâ‰∏ã] ÁîªÂ∏ÉËßÜÂè£: button=${e.button}, clientX=${e.clientX}, clientY=${e.clientY}`, 'event');
                }
                if (e.button === 1) {
                    e.preventDefault();
                    AppState.isMiddleMouseDown = true;
                    AppState.lastMouseX = e.clientX;
                    AppState.lastMouseY = e.clientY;
                    canvasViewport.style.cursor = 'grabbing';
                    if (showMouseLogs) {
                        debugLog(`[ÂºÄÂßãÊãñÂä®] ÁîªÂ∏É: isMiddleMouseDown=${AppState.isMiddleMouseDown}`, 'info');
                    }
                } else {
                    canvasViewport.style.cursor = 'default';
                }
            });
            
            canvasViewport.addEventListener('mouseenter', () => {
                canvasViewport.style.cursor = 'default';
                canvas.style.cursor = 'default';
            });
            
            canvasViewport.addEventListener('mouseup', (e) => {
                if (showMouseLogs) {
                    debugLog(`[Èº†Ê†áÈáäÊîæ] ÁîªÂ∏ÉËßÜÂè£: button=${e.button}, clientX=${e.clientX}, clientY=${e.clientY}`, 'event');
                }
                if (e.button === 1) {
                    AppState.isMiddleMouseDown = false;
                    canvasViewport.style.cursor = 'default';
                    if (showMouseLogs) {
                        debugLog(`[ÂÅúÊ≠¢ÊãñÂä®] ÁîªÂ∏É: isMiddleMouseDown=${AppState.isMiddleMouseDown}`, 'info');
                    }
                }
            });
            
            canvasViewport.addEventListener('mouseleave', () => {
                AppState.isMiddleMouseDown = false;
                canvasViewport.style.cursor = '';
                canvas.style.cursor = '';
            });
            
            canvasViewport.addEventListener('contextmenu', (e) => {
                // Ê£ÄÊü•ÊòØÂê¶ÁÇπÂáªÂú®ÂõæÁâáËäÇÁÇπ‰∏äÔºåÂ¶ÇÊûúÊòØÂàô‰∏çÊòæÁ§∫ÁîªÂ∏ÉËèúÂçï
                const targetNode = e.target.closest('.canvas-node');
                if (targetNode) {
                    return; // ËÆ©‰∫ã‰ª∂ÁªßÁª≠‰º†Êí≠Âà∞ÂõæÁâáËäÇÁÇπÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
                }
                
                e.preventDefault();
                
                const existingMenu = document.querySelector('.context-menu');
                if (existingMenu) {
                    existingMenu.remove();
                }
                
                const menu = document.createElement('div');
                menu.className = 'context-menu';
                menu.style.left = `${e.clientX}px`;
                menu.style.top = `${e.clientY}px`;
                
                const centerItem = document.createElement('div');
                centerItem.className = 'context-menu-item';
                centerItem.textContent = 'ÂõûÂà∞‰∏≠ÂøÉ';
                centerItem.addEventListener('click', () => {
                    resetCanvas();
                    menu.remove();
                });
                
                menu.appendChild(centerItem);
                document.body.appendChild(menu);
                
                const closeMenu = () => {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                };
                
                setTimeout(() => {
                    document.addEventListener('click', closeMenu);
                }, 0);
            });
            
            if (resetCanvasBtn) {
                resetCanvasBtn.addEventListener('click', resetCanvas);
            }
            
            initMinimap();
            console.log('Canvas initialized successfully');
        }

        // ÁîüÊàêË∞ÉËØïÁΩëÊ†º
        function generateDebugGrid() {
            const svg = document.getElementById('debugGridSvg');
            if (!svg) return;
            
            let svgContent = '';
            
            // ÁîüÊàêÁΩëÊ†ºÁ∫ø
            for (let i = 0; i <= 100; i++) {
                const pos = i * 100;
                // ÂûÇÁõ¥Á∫ø
                svgContent += `<line x1="${pos}" y1="0" x2="${pos}" y2="10000" stroke="#00ff00" stroke-width="1" stroke-opacity="0.2"/>`;
                // Ê∞¥Âπ≥Á∫ø
                svgContent += `<line x1="0" y1="${pos}" x2="10000" y2="${pos}" stroke="#00ff00" stroke-width="1" stroke-opacity="0.2"/>`;
            }
            
            // ÁîüÊàêÁΩëÊ†ºÊñáÂ≠óÔºàÊØè‰∏™Ê†ºÂ≠ê‰∏≠ÂøÉÔºâ
            for (let row = 1; row <= 100; row++) {
                for (let col = 1; col <= 100; col++) {
                    const x = (col - 1) * 100 + 50;
                    const y = (row - 1) * 100 + 50;
                    svgContent += `<text x="${x}" y="${y}" font-size="12" text-anchor="middle" dominant-baseline="middle" fill="#00ff00" fill-opacity="0.5">${row}.${col}</text>`;
                }
            }
            
            svg.innerHTML = svgContent;
        }

        function resetCanvas() {
            if (panzoom) {
                panzoom.reset();
                refreshUI();
            }
        }

        // ÁÆÄÂçïÁöÑUIÂà∑Êñ∞ÂáΩÊï∞
        function refreshUI() {
            updateCenterMarkerCoordinates();
            updateMinimapViewport();
        }

        // Êõ¥Êñ∞‰∏≠ÂøÉÊ†áËÆ∞ÁöÑÂùêÊ†áÊòæÁ§∫
        function updateCenterMarkerCoordinates() {
            const centerMarker = document.getElementById('canvasCenterMarker');
            if (!centerMarker) return;
            
            // ËÆ°ÁÆóËßÜÂè£‰∏≠ÂøÉÂùêÊ†áÔºåËÄÉËôëÂè≥‰æßÈù¢ÊùøË°•ÂÅø
            const uiPanel = document.getElementById('uiPanel');
            const uiPanelWidth = uiPanel ? uiPanel.offsetWidth : 400;
            const viewportCenterX = (window.innerWidth - uiPanelWidth) / 2;
            const viewportCenterY = window.innerHeight / 2;
            
            // ‰øÆÊ≠£ÂêéÁöÑÂÖ¨ÂºèÔºö(ËßÜÂè£‰∏≠ÂøÉÁõ∏ÂØπ‰∫éÁîªÂ∏ÉÂ∑¶‰∏äËßíÁöÑÁªùÂØπ‰ΩçÁΩÆ)
            const scale = panzoom.getScale();
            const displayX = Math.round((viewportCenterX - AppState.panX) / scale);
            const displayY = Math.round((viewportCenterY - AppState.panY) / scale);
            
            // Êõ¥Êñ∞ÂùêÊ†áÊòæÁ§∫
            const coordText = centerMarker.querySelector('div:nth-child(2)');
            if (coordText) {
                coordText.textContent = `‰∏≠ÂøÉÂùêÊ†á: (${displayX}, ${displayY})`;
            }
        }
        
        function updateImageCenterCoordinates(node) {
            if (!node) return;
            
            // Ëé∑ÂèñÂõæÁâá‰ΩçÁΩÆÂíåÂ∞∫ÂØ∏
            const left = parseInt(node.style.left) || 0;
            const top = parseInt(node.style.top) || 0;
            const width = parseInt(node.dataset.width) || 500;
            const height = parseInt(node.dataset.height) || 500;
            
            // ËÆ°ÁÆó‰∏≠ÂøÉÂùêÊ†á
            const centerX = Math.round(left + width / 2);
            const centerY = Math.round(top + height / 2);
            
            // Êõ¥Êñ∞ÂùêÊ†áÊòæÁ§∫
            const coordsElement = node.querySelector('.node-center-coords');
            if (coordsElement) {
                coordsElement.textContent = `(${centerX}, ${centerY})`;
            }
        }

        function updateMinimapViewport() {
            const ratio = 200 / 10000;
            const viewportBox = document.getElementById('minimapViewport');
            const uiPanel = document.getElementById('uiPanel');
            const uiPanelWidth = uiPanel ? uiPanel.offsetWidth : 400;

            if (!viewportBox || typeof AppState.panX === 'undefined') return;

            // 1. Áâ©ÁêÜËßÜÂè£ÂÆΩÈ´ò
            const vW_phys = window.innerWidth - uiPanelWidth;
            const vH_phys = window.innerHeight;

            // 2. ËìùÊ°ÜÂ§ßÂ∞è (Ê≠£ÊØî‰∫éÁâ©ÁêÜËßÜÂè£ÔºåÂèçÊØî‰∫éÁº©ÊîæÂÄçÊï∞)
            const vW_minimap = (vW_phys / AppState.scale) * ratio;
            const vH_minimap = (vH_phys / AppState.scale) * ratio;

            // 3. „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëËÆ°ÁÆóÂΩìÂâçÂ±èÂπïÊ≠£‰∏≠ÂøÉÔºåÂú® 10000x10000 ÈÄªËæëÁîªÂ∏É‰∏äÁöÑÁªùÂØπÂùêÊ†á
            // ÂÖ¨ÂºèÔºö‰∏≠ÂøÉÂü∫ÂáÜ 5000 + (Áâ©ÁêÜ‰∏≠ÂøÉÁÇπ - ‰∏≠ÂøÉÂéüÂáÜÁÇπ 5000 - Áâ©ÁêÜÂÅèÁßª) / Áº©ÊîæÂÄçÊï∞
            const logicCenterX = 5000 + (vW_phys / 2 - 5000 - AppState.panX) / AppState.scale;
            const logicCenterY = 5000 + (vH_phys / 2 - 5000 - AppState.panY) / AppState.scale;

            // 4. Â∞ÜÈÄªËæë‰∏≠ÂøÉÊò†Â∞ÑÂà∞Áº©Áï•ÂõæÔºåÂπ∂ÂáèÂéªËìùÊ°ÜËá™Ë∫´ÁöÑ‰∏ÄÂçäÔºåÂÆûÁé∞ÂÆåÁæéÂ±Ö‰∏≠
            const minimapCenterX = logicCenterX * ratio;
            const minimapCenterY = logicCenterY * ratio;

            viewportBox.style.width = `${vW_minimap}px`;
            viewportBox.style.height = `${vH_minimap}px`;
            viewportBox.style.left = `${minimapCenterX - vW_minimap / 2}px`;
            viewportBox.style.top = `${minimapCenterY - vH_minimap / 2}px`;
        }

        function updateMinimapWithImage(node) {
            const minimapScale = 200 / 10000;
            const img = node.querySelector('img');
            
            if (!img) {
                return;
            }
            
            if (!img.complete) {
                img.onload = () => updateMinimapWithImage(node);
                return;
            }
            
            const nodeLeft = parseInt(node.style.left) || 0;
            const nodeTop = parseInt(node.style.top) || 0;
            const nodeWidth = img.offsetWidth || parseInt(img.style.width) || 200;
            const nodeHeight = img.offsetHeight || parseInt(img.style.height) || 200;
            
            // ÁîªÂ∏ÉÁöÑ(5000, 5000)ÂØπÂ∫îÁº©Áï•ÂõæÁöÑ(100, 100)
            const minimapLeft = 100 + (nodeLeft - 5000) * minimapScale;
            const minimapTop = 100 + (nodeTop - 5000) * minimapScale;
            const minimapWidth = nodeWidth * minimapScale;
            const minimapHeight = nodeHeight * minimapScale;
            
            let minimapImage = minimapCanvas.querySelector(`[data-node-id="${node.dataset.index}"]`);
            
            if (!minimapImage) {
                minimapImage = document.createElement('div');
                minimapImage.className = 'minimap-image';
                minimapImage.dataset.nodeId = node.dataset.index;
                minimapImage.style.zIndex = '1';
                minimapCanvas.appendChild(minimapImage);
            }
            
            minimapImage.style.left = `${minimapLeft}px`;
            minimapImage.style.top = `${minimapTop}px`;
            minimapImage.style.width = `${minimapWidth}px`;
            minimapImage.style.height = `${minimapHeight}px`;
        }

        function updateAllMinimapImages() {
            const nodes = imageResponseContainer.querySelectorAll('.canvas-node');
            nodes.forEach(node => {
                updateMinimapWithImage(node);
            });
        }

        function initMinimap() {
            updateMinimapViewport();
            updateAllMinimapImages();
            
            // ‰øÆÂ§ç 1ÔºöÁÇπÂáªÁº©Áï•ÂõæË∑≥ËΩ¨ÈÄªËæë
            minimapCanvas.addEventListener('click', (e) => {
                if (e.target === minimapViewport) return;
                
                const rect = minimapCanvas.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const clickY = e.clientY - rect.top;
                
                const minimapScale = 200 / 10000;
                const scale = panzoom.getScale();
                
                const targetLogicX = clickX / minimapScale;
                const targetLogicY = clickY / minimapScale;
                
                const uiPanel = document.getElementById('uiPanel');
                const uiPanelWidth = uiPanel ? uiPanel.offsetWidth : 400;
                const vW_phys = window.innerWidth - uiPanelWidth;
                const vH_phys = window.innerHeight;

                // „ÄêÂèçÂêëÊé®ÂØºÂÖ¨Âºè„ÄëÁÆóÂá∫Ë¶ÅËÆ©ËØ•ÁÇπÂ±Ö‰∏≠ÔºåÈúÄË¶ÅÂ§öÂ∞ëÁâ©ÁêÜÂÅèÁßª
                const newPanX = vW_phys / 2 - 5000 - (targetLogicX - 5000) * scale;
                const newPanY = vH_phys / 2 - 5000 - (targetLogicY - 5000) * scale;
                
                // ‰∫§Áªô panzoom Â§ÑÁêÜÔºåÂÆÉ‰ºöËá™Âä®Êõ¥Êñ∞Ê†∑ÂºèÂπ∂Ëß¶Âèë panzoompan ‰∫ã‰ª∂
                panzoom.pan(newPanX, newPanY);
            });
            
            minimapViewport.addEventListener('mousedown', (e) => {
                e.preventDefault();
                isDraggingMinimapViewport = true;
                minimapDragStartX = e.clientX;
                minimapDragStartY = e.clientY;
                minimapPanStartX = AppState.panX;
                minimapPanStartY = AppState.panY;
            });
            
            // ‰øÆÂ§ç 2ÔºöÊãñÊãΩËìùÊ°ÜÈÄªËæëÔºà‰øÆÊ≠£Ê≠£Ë¥üÂè∑Âíå‰πòÈô§Ê≥ïÔºâ
            document.addEventListener('mousemove', (e) => {
                if (isDraggingMinimapViewport) {
                    const deltaX = e.clientX - minimapDragStartX;
                    const deltaY = e.clientY - minimapDragStartY;
                    
                    const minimapScale = 200 / 10000;
                    const scale = panzoom.getScale();
                    
                    // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëËìùÊ°ÜÂæÄÂè≥Ëµ∞(Ê≠£)Ôºå‰ª£Ë°®ËßÜÂè£ÂæÄÂè≥ÔºåÊÑèÂë≥ÁùÄÁîªÂ∏ÉÂøÖÈ°ªÂæÄÂ∑¶ÈÄÄ(Ë¥ü)ÔºÅÂπ∂‰∏îÂøÖÈ°ª‰πò‰∏ä scale„ÄÇ
                    const newPanX = minimapPanStartX - (deltaX / minimapScale) * scale;
                    const newPanY = minimapPanStartY - (deltaY / minimapScale) * scale;
                    
                    panzoom.pan(newPanX, newPanY);
                }
            });
            
            document.addEventListener('mouseup', () => {
                if (isDraggingMinimapViewport) {
                    isDraggingMinimapViewport = false;
                }
            });
        }

        uploadImageBtn.addEventListener('click', () => {
            imageUploadInput.click();
        });

        imageUploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const imageUrl = event.target.result;
                    const node = createImageNode(imageUrl, file.name, nodeCounter++, file.name, '');
                    imageResponseContainer.appendChild(node);
                    debugLog(`[ÂõæÁâá‰∏ä‰º†] Êñá‰ª∂Âêç: ${file.name}`, 'info');
                };
                reader.readAsDataURL(file);
            }
            imageUploadInput.value = '';
        });

        // Áº©ÊîæÊéßÂà∂‰∫ã‰ª∂
        zoomSlider.addEventListener('input', (e) => {
            const newScale = parseInt(e.target.value) / 100;
            updateCanvasScale(newScale);
        });

        zoomOutBtn.addEventListener('click', () => {
            const currentScale = panzoom.getScale();
            const newScale = Math.max(0.5, currentScale - 0.25);
            updateCanvasScale(newScale);
        });

        zoomInBtn.addEventListener('click', () => {
            const currentScale = panzoom.getScale();
            const newScale = Math.min(2.5, currentScale + 0.25);
            updateCanvasScale(newScale);
        });

        zoomResetBtn.addEventListener('click', () => {
            updateCanvasScale(1);
        });

        zoomValue.addEventListener('click', () => {
            updateCanvasScale(1);
        });

        function updateCanvasScale(newScale) {
            const uiPanel = document.getElementById('uiPanel');
            const uiPanelWidth = uiPanel ? uiPanel.offsetWidth : 400;
            
            const focalX = (window.innerWidth - uiPanelWidth) / 2;
            const focalY = window.innerHeight / 2;
            
            const focalPoint = { x: focalX, y: focalY };
            
            panzoom.zoom(newScale, { focalPoint, animate: true });
            zoomSlider.value = Math.round(newScale * 100);
            zoomValue.textContent = `${Math.round(newScale * 100)}%`;
            debugLog(`[Áº©Êîæ] Êñ∞Áº©Êîæ: ${Math.round(newScale * 100)}%`, 'info');
        }

        document.addEventListener('mousemove', (e) => {
            if (AppState.isDraggingNode && AppState.dragNode) {
                const scale = panzoom.getScale();
                const deltaX = (e.clientX - AppState.dragStartX) / scale;
                const deltaY = (e.clientY - AppState.dragStartY) / scale;
                
                const newLeft = AppState.dragNodeStartLeft + deltaX;
                const newTop = AppState.dragNodeStartTop + deltaY;
                
                AppState.dragNode.style.left = `${newLeft}px`;
                AppState.dragNode.style.top = `${newTop}px`;
                
                // Êõ¥Êñ∞ÂõæÁâá‰∏≠ÂøÉÂùêÊ†á
                updateImageCenterCoordinates(AppState.dragNode);
                
                updateMinimapWithImage(AppState.dragNode);
                
                if (showMouseLogs) {
                    debugLog(`ÊãñÂä®ÂõæÁâá: delta=(${deltaX},${deltaY}), newPos=(${newLeft},${newTop}), scale=${scale}`, 'event');
                }
            }
            
            if (AppState.isMiddleMouseDown && !AppState.isDraggingNode) {
                const deltaX = e.clientX - AppState.lastMouseX;
                const deltaY = e.clientY - AppState.lastMouseY;
                
                const newPanX = AppState.panX + deltaX;
                const newPanY = AppState.panY + deltaY;
                
                // ËÆæÁΩÆÂêàÁêÜÁöÑËæπÁïåÈôêÂà∂ÔºåÈò≤Ê≠¢Áî®Êà∑Â§±ÊâãÁî©È£ûÁîªÂ∏É
                // ÁîªÂ∏ÉÂ∞∫ÂØ∏ÊòØ10000√ó10000Ôºå‰∏≠ÂøÉÂú®(0,0)ÔºåÊâÄ‰ª•ËæπÁïåÊòØ¬±5000
                // ËÆæÁΩÆ‰∏Ä‰∏™ÂºπÊÄßËæπÁïå¬±8000ÔºåÂÖÅËÆ∏‰∏ÄÂÆöÁöÑÊãñÂá∫ËåÉÂõ¥
                const minPanX = -8000;
                const maxPanX = 8000;
                const minPanY = -8000;
                const maxPanY = 8000;
                
                AppState.panX = Math.max(minPanX, Math.min(newPanX, maxPanX));
                AppState.panY = Math.max(minPanY, Math.min(newPanY, maxPanY));
                
                // ‰ΩøÁî®requestAnimationFrameÁ°Æ‰øùÂùêÊ†áÊõ¥Êñ∞‰∏éÊµèËßàÂô®Ê∏≤ÊüìÂêåÊ≠•
                requestAnimationFrame(() => {
                    const scale = panzoom.getScale();
                    canvas.style.transform = `translate(${AppState.panX}px, ${AppState.panY}px) scale(${scale})`;
                    updateMinimapViewport();
                    updateCenterMarkerCoordinates();
                });
                
                // ÂÖàËÆ°ÁÆódeltaXÂíådeltaYÔºåÂÜçÊõ¥Êñ∞lastMouseXÂíålastMouseY
                AppState.lastMouseX = e.clientX;
                AppState.lastMouseY = e.clientY;
                
                if (Math.abs(deltaX) > 1 || Math.abs(deltaY) > 1) {
                    if (!debugConsole.contains(e.target) && showMouseLogs) {
                        debugLog(`ÁîªÂ∏ÉÊãñÂä®: deltaX=${deltaX}, deltaY=${deltaY}, panX=${AppState.panX}, panY=${AppState.panY}`, 'event');
                    }
                }
            }
            
            if (AppState.isResizingNode && AppState.resizeNode) {
                const deltaX = e.clientX - AppState.resizeStart.x;
                const deltaY = e.clientY - AppState.resizeStart.y;
                const delta = (deltaX >= 0 || deltaY >= 0) ? Math.max(deltaX, deltaY) : Math.min(deltaX, deltaY);
                
                const aspectRatio = AppState.resizeStart.width / AppState.resizeStart.height;
                let newWidth = AppState.resizeStart.width + delta;
                let newHeight = newWidth / aspectRatio;
                
                if (newWidth > 50 && newHeight > 50) {
                    const img = AppState.resizeNode.querySelector('img');
                    img.style.width = `${newWidth}px`;
                    img.style.height = `${newHeight}px`;
                    updateMinimapWithImage(AppState.resizeNode);
                    refreshPinsOnNode(AppState.resizeNode);
                }
            }
        });

        document.addEventListener('mouseup', (e) => {
            if (debugConsole.contains(e.target)) return;
            if (showMouseLogs) {
                debugLog(`[Èº†Ê†áÊä¨Ëµ∑] ÂÖ®Â±Ä: button=${e.button}, clientX=${e.clientX}, clientY=${e.clientY}`, 'event');
            }
            
            if (AppState.isDraggingNode && AppState.dragNode) {
                if (showMouseLogs) {
                    debugLog(`[ÁªìÊùüÊãñÂä®] ÂõæÁâá: node=${AppState.dragNode.dataset.filename}`, 'info');
                }
                AppState.dragNode.style.cursor = 'grab';
                AppState.isDraggingNode = false;
                AppState.dragNode = null;
            }
            
            if (AppState.isResizingNode && AppState.resizeNode) {
                if (showMouseLogs) {
                    debugLog(`[ÁªìÊùüË∞ÉÊï¥Â§ßÂ∞è] ËäÇÁÇπ: node=${AppState.resizeNode.dataset.filename}`, 'info');
                }
                AppState.isResizingNode = false;
                AppState.resizeNode = null;
                document.body.style.cursor = '';
            }
            
            if (AppState.isMiddleMouseDown) {
                if (showMouseLogs) {
                    debugLog(`[Èº†Ê†á‰∏≠ÈîÆÈáäÊîæ] ÂÖ®Â±Ä: isMiddleMouseDown=${AppState.isMiddleMouseDown}`, 'info');
                }
                AppState.isMiddleMouseDown = false;
                canvasViewport.style.cursor = 'default';
            }
        });

        function createImageNode(imageUrl, prompt = '', index = 0, filename = '', resolution = '') {
            console.log('Creating image node...');
            console.log('Image URL:', imageUrl);
            console.log('Prompt:', prompt);
            console.log('Index:', index);
            console.log('Filename:', filename);
            console.log('Resolution:', resolution);
            
            const node = document.createElement('div');
            node.className = 'canvas-node';
            node.dataset.index = index;
            node.dataset.imageUrl = imageUrl;
            node.dataset.filename = filename || `Image ${index + 1}`;
            
            const img = document.createElement('img');
            img.src = imageUrl;
            img.alt = `Generated image ${index + 1}`;
            img.draggable = false;
            
            img.onload = function() {
                const width = this.naturalWidth;
                const height = this.naturalHeight;
                const resolutionText = `${width}x${height}`;
                const resolutionElement = node.querySelector('.node-resolution');
                if (resolutionElement) {
                    resolutionElement.textContent = resolutionText;
                }
                node.dataset.width = width;
                node.dataset.height = height;
                
                // Êõ¥Êñ∞ÂõæÁâá‰∏≠ÂøÉÂùêÊ†á
                updateImageCenterCoordinates(node);
            };
            
            const header = document.createElement('div');
            header.className = 'node-header';
            
            const filenameElement = document.createElement('div');
            filenameElement.className = 'node-filename';
            filenameElement.textContent = filename || `Image ${index + 1}`;
            
            const resolutionElement = document.createElement('div');
            resolutionElement.className = 'node-resolution';
            resolutionElement.textContent = resolution || 'Loading...';
            
            header.appendChild(filenameElement);
            header.appendChild(resolutionElement);
            
            // ÂàõÂª∫ÊÇ¨ÊµÆÂ∑•ÂÖ∑Ê†è
            const toolbar = document.createElement('div');
            toolbar.className = 'node-toolbar';
            
            // Ê∑ªÂä†Â§çÂà∂ÊèêÁ§∫ËØçÊåâÈíÆ
            const copyPromptBtn = document.createElement('button');
            copyPromptBtn.className = 'toolbar-btn';
            copyPromptBtn.innerHTML = 'üìù';
            copyPromptBtn.title = 'Â§çÂà∂ÊèêÁ§∫ËØç';
            copyPromptBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                navigator.clipboard.writeText(prompt || '').then(() => {
                    if (showMouseLogs) {
                        debugLog(`[Â§çÂà∂] ÊèêÁ§∫ËØç: ${node.dataset.filename}`, 'info');
                    }
                });
            });
            
            // Ê∑ªÂä†ÊèíÂÖ•Âà∞ËæìÂÖ•Ê°ÜÊåâÈíÆ
            const insertBtn = document.createElement('button');
            insertBtn.className = 'toolbar-btn';
            insertBtn.innerHTML = '‚úèÔ∏è';
            insertBtn.title = 'ÊèíÂÖ•Âà∞ËæìÂÖ•Ê°Ü';
            insertBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const img = node.querySelector('img');
                if (img) {
                    const imageUrl = img.src;
                    const filename = node.dataset.filename || 'Image';
                    insertImageToPrompt(imageUrl, filename);
                    debugLog(`[Â∑•ÂÖ∑Ê†è] ÊèíÂÖ•ÂõæÁâáÂà∞ËæìÂÖ•Ê°Ü: node=${node.dataset.filename}`, 'info');
                }
            });
            
            // Ê∑ªÂä†Â§çÂà∂ÊåâÈíÆ
            const copyBtn = document.createElement('button');
            copyBtn.className = 'toolbar-btn';
            copyBtn.innerHTML = 'üìã';
            copyBtn.title = 'Â§çÂà∂ÂõæÁâá';
            copyBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                selectNode(node);
                copySelectedNode();
            });
            
            // Ê∑ªÂä†Âà†Èô§ÊåâÈíÆ
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'toolbar-btn';
            deleteBtn.innerHTML = 'üóëÔ∏è';
            deleteBtn.title = 'Âà†Èô§ÂõæÁâá';
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                selectNode(node);
                deleteSelectedNode();
            });
            
            toolbar.appendChild(copyPromptBtn);
            toolbar.appendChild(insertBtn);
            toolbar.appendChild(copyBtn);
            toolbar.appendChild(deleteBtn);
            
            // ÂàõÂª∫‰∏≠ÂøÉÂùêÊ†áÊòæÁ§∫
            const centerCoords = document.createElement('div');
            centerCoords.className = 'node-center-coords';
            centerCoords.textContent = '(0, 0)';
            
            const resizeHandle = document.createElement('div');
            resizeHandle.className = 'resize-handle';
            
            const info = document.createElement('div');
            info.className = 'node-info';
            info.textContent = prompt || `Image ${index + 1}`;
            
            node.appendChild(header);
            node.appendChild(toolbar);
            node.appendChild(img);
            node.appendChild(resizeHandle);
            node.appendChild(info);
            node.appendChild(centerCoords);
            
            node.dataset.pins = JSON.stringify([]);
            
            // Áõ¥Êé•ËÆæÁΩÆ‰∏≠ÂøÉ‰ΩçÁΩÆÔºå‰∏çÈúÄË¶ÅÁ≠âÂæÖonload‰∫ã‰ª∂
            const width = parseInt(img.style.width) || 500;
            const height = parseInt(img.style.height) || 500;
            // ËÆæÁΩÆ‰∏∫ÁîªÂ∏É‰∏≠ÂøÉ (0, 0)ÔºåËøôÊ†∑‰ºöÊòæÁ§∫Âú®ËßÜÂè£‰∏≠ÂøÉ
            node.style.left = `${5000 - width / 2}px`;
            node.style.top = `${5000 - height / 2}px`;
            
            // ÂØπ‰∫éÂèØËÉΩÈúÄË¶ÅËÆ°ÁÆóÂÆûÈôÖÂ∞∫ÂØ∏ÁöÑÂõæÁâáÔºå‰ªçÁÑ∂Ê∑ªÂä†onload‰∫ã‰ª∂
            img.onload = function() {
                const actualWidth = this.naturalWidth || parseInt(this.style.width) || 500;
                const actualHeight = this.naturalHeight || parseInt(this.style.height) || 500;
                // ‰øùÊåÅÂú®ÁîªÂ∏É‰∏≠ÂøÉ
                node.style.left = `${5000 - actualWidth / 2}px`;
                node.style.top = `${5000 - actualHeight / 2}px`;
                
                // Êõ¥Êñ∞ÂàÜËæ®ÁéáÊòæÁ§∫
                const resolutionText = `${actualWidth}x${actualHeight}`;
                const resolutionElement = node.querySelector('.node-resolution');
                if (resolutionElement) {
                    resolutionElement.textContent = resolutionText;
                }
                
                // Êõ¥Êñ∞ËäÇÁÇπÊï∞ÊçÆ
                node.dataset.width = actualWidth;
                node.dataset.height = actualHeight;
                
                // Êõ¥Êñ∞ÂõæÁâá‰∏≠ÂøÉÂùêÊ†á
                updateImageCenterCoordinates(node);
                
                // Êõ¥Êñ∞Áº©Áï•Âõæ
                updateMinimapWithImage(node);
            };
            
            // Á´ãÂç≥Êõ¥Êñ∞Áº©Áï•Âõæ
            updateMinimapWithImage(node);
            
            img.addEventListener('click', (e) => {
                e.stopPropagation();
                if (showMouseLogs) {
                    debugLog(`ÂõæÁâáÁÇπÂáª: button=${e.button}, ctrlKey=${e.ctrlKey}, metaKey=${e.metaKey}, selected=${node.classList.contains('selected')}`, 'event');
                }
                if (e.ctrlKey || e.metaKey) {
                    if (node.classList.contains('selected')) {
                        if (showMouseLogs) {
                            debugLog(`Ê∑ªÂä† PIN: ÂõæÁâáÂ∑≤ÈÄâ‰∏≠`, 'info');
                        }
                        addPinToImage(node, e);
                    } else {
                        if (showMouseLogs) {
                            debugLog(`ÈÄâ‰∏≠ÂõæÁâá: Êú™ÈÄâ‰∏≠ÔºåÊåâ‰Ωè Ctrl/Meta`, 'info');
                        }
                        selectNode(node);
                    }
                } else {
                    if (showMouseLogs) {
                        debugLog(`ÈÄâ‰∏≠ÂõæÁâá: Â∑¶ÈîÆÁÇπÂáª`, 'info');
                    }
                    selectNode(node);
                }
            });
            
            node.addEventListener('mousedown', (e) => {
                if (showMouseLogs) {
                    debugLog(`[Èº†Ê†áÊåâ‰∏ã] ËäÇÁÇπ: button=${e.button}, clientX=${e.clientX}, clientY=${e.clientY}, selected=${node.classList.contains('selected')}, ctrlKey=${e.ctrlKey}, metaKey=${e.metaKey}`, 'event');
                }
                if (e.button === 0 && !e.ctrlKey && !e.metaKey) {
                    e.stopPropagation();
                    selectNode(node);
                    
                    // ËÆæÁΩÆÂÖ®Â±ÄÊãñÂä®Áä∂ÊÄÅ
                    AppState.isDraggingNode = true;
                    AppState.dragNode = node;
                    AppState.activeNode = node;
                    
                    // ËÆ∞ÂΩïÂàùÂßã‰ΩçÁΩÆ
                    AppState.dragStartX = e.clientX;
                    AppState.dragStartY = e.clientY;
                    AppState.dragNodeStartLeft = parseInt(node.style.left || '0');
                    AppState.dragNodeStartTop = parseInt(node.style.top || '0');
                    
                    if (showMouseLogs) {
                        debugLog(`[ÂºÄÂßãÊãñÂä®] ÂõæÁâá: node=${node.dataset.filename}`, 'info');
                    }
                }
            });
            
            node.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                showImageContextMenu(e, node, img);
            });
            
            img.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                showImageContextMenu(e, node, img);
            });
            
            resizeHandle.addEventListener('mousedown', (e) => {
                e.stopPropagation();
                e.preventDefault();
                startResizeNode(e, node);
            });
            
            console.log('Node created:', node);
            return node;
        }

        function selectNode(node) {
            if (selectedNode) {
                selectedNode.classList.remove('selected');
            }
            selectedNode = node;
            node.classList.add('selected');
        }



        function startResizeNode(e, node) {
            AppState.isResizingNode = true;
            AppState.resizeNode = node;
            const img = node.querySelector('img');
            AppState.resizeStart = {
                x: e.clientX,
                y: e.clientY,
                width: img.width,
                height: img.height
            };
            document.body.style.cursor = 'nwse-resize';
        }

        canvas.addEventListener('click', (e) => {
            if (debugConsole.contains(e.target)) return;
            
            // ËÆ©ËæìÂÖ•Ê°ÜÂ§±ÂéªÁÑ¶ÁÇπ
            if (document.activeElement === promptInput) {
                promptInput.blur();
            }
            
            if (showMouseLogs) {
                debugLog(`ÁîªÂ∏ÉÁÇπÂáª: button=${e.button}, target=${e.target.id || e.target.className}`, 'event');
            }
            if (e.target === canvas || e.target === imageResponseContainer) {
                if (showMouseLogs) {
                    debugLog(`ÂèñÊ∂àÈÄâ‰∏≠ÊâÄÊúâËäÇÁÇπ`, 'info');
                }
                deselectAllNodes();
            }
        });

        function deselectAllNodes() {
            if (selectedNode) {
                selectedNode.classList.remove('selected');
                selectedNode = null;
            }
        }

        let clipboardNode = null;

        function copySelectedNode() {
            if (!selectedNode) return;
            
            const img = selectedNode.querySelector('img');
            if (!img) return;
            
            if (img.src.startsWith('data:')) {
                navigator.clipboard.writeText(img.src).then(() => {
                    console.log('ÂõæÁâáÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');
                    if (showMouseLogs) {
                        debugLog(`[Â§çÂà∂] ÂõæÁâá: ${selectedNode.dataset.filename}`, 'info');
                    }
                    clipboardNode = selectedNode;
                }).catch(err => {
                    console.error('Â§çÂà∂Â§±Ë¥•:', err);
                    debugLog(`[Â§çÂà∂Â§±Ë¥•] ${err}`, 'error');
                });
            } else {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = img.naturalWidth || img.width;
                canvas.height = img.naturalHeight || img.height;
                
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                canvas.toBlob((blob) => {
                    navigator.clipboard.write([
                        new ClipboardItem({
                            'image/png': blob
                        })
                    ]).then(() => {
                        console.log('ÂõæÁâáÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');
                        if (showMouseLogs) {
                            debugLog(`[Â§çÂà∂] ÂõæÁâá: ${selectedNode.dataset.filename}`, 'info');
                        }
                        clipboardNode = selectedNode;
                    }).catch(err => {
                        console.error('Â§çÂà∂Â§±Ë¥•:', err);
                        debugLog(`[Â§çÂà∂Â§±Ë¥•] ${err}`, 'error');
                    });
                });
            }
        }

        function cutSelectedNode() {
            if (!selectedNode) return;
            
            clipboardNode = selectedNode.cloneNode(true);
            deleteSelectedNode(true);
            debugLog(`[Ââ™Âàá] ÂõæÁâá: ${selectedNode.dataset.filename}`, 'info');
        }

        function deleteSelectedNode(skipConfirm = false) {
            if (!selectedNode) return;
            
            const showDeleteConfirm = () => {
                const confirmModal = document.getElementById('confirmModal');
                const confirmModalMessage = document.getElementById('confirmModalMessage');
                const confirmModalCheckbox = document.getElementById('confirmModalCheckbox');
                const confirmModalCancel = document.getElementById('confirmModalCancel');
                const confirmModalOk = document.getElementById('confirmModalOk');
                
                confirmModalMessage.textContent = `Á°ÆÂÆöË¶ÅÂà†Èô§ÂõæÁâá"${selectedNode.dataset.filename}"ÂêóÔºü`;
                confirmModal.classList.remove('hidden');
                confirmModal.classList.add('flex');
                
                const handleConfirm = () => {
                    const dontShowAgain = confirmModalCheckbox.checked;
                    
                    if (dontShowAgain) {
                        localStorage.setItem('dontShowDeleteConfirm', 'true');
                    }
                    
                    performDelete();
                    closeConfirmModal();
                };
                
                const handleCancel = () => {
                    closeConfirmModal();
                };
                
                const closeConfirmModal = () => {
                    confirmModal.classList.add('hidden');
                    confirmModal.classList.remove('flex');
                    confirmModalOk.removeEventListener('click', handleConfirm);
                    confirmModalCancel.removeEventListener('click', handleCancel);
                };
                
                confirmModalOk.addEventListener('click', handleConfirm);
                confirmModalCancel.addEventListener('click', handleCancel);
            };
            
            const performDelete = () => {
                const minimapImage = minimapCanvas.querySelector(`[data-node-id="${selectedNode.dataset.index}"]`);
                if (minimapImage) {
                    minimapImage.remove();
                }
                selectedNode.remove();
                selectedNode = null;
                debugLog(`[Âà†Èô§] ÂõæÁâá: ${selectedNode?.dataset.filename}`, 'info');
            };
            
            const dontShowConfirm = localStorage.getItem('dontShowDeleteConfirm') === 'true';
            
            if (skipConfirm || dontShowConfirm) {
                performDelete();
            } else {
                showDeleteConfirm();
            }
        }

        function pasteNode() {
            if (!clipboardNode) return;
            
            const imageUrl = clipboardNode.dataset.imageUrl;
            const prompt = clipboardNode.querySelector('.node-info')?.textContent || '';
            const filename = clipboardNode.dataset.filename;
            const resolution = `${clipboardNode.dataset.width || 500}x${clipboardNode.dataset.height || 500}`;
            
            const newNode = createImageNode(imageUrl, prompt, nodeCounter++, filename, resolution);
            
            // ÂÅèÁßª‰∏ÄÁÇπ‰ΩçÁΩÆÔºåÈÅøÂÖçÂÆåÂÖ®ÈáçÂè†
            const offsetX = 20;
            const offsetY = 20;
            const currentLeft = parseInt(clipboardNode.style.left) || 5000;
            const currentTop = parseInt(clipboardNode.style.top) || 5000;
            newNode.style.left = `${currentLeft + offsetX}px`;
            newNode.style.top = `${currentTop + offsetY}px`;
            
            // Ê∑ªÂä†Âà∞ÁîªÂ∏É
            imageResponseContainer.appendChild(newNode);
            
            // ÈÄâ‰∏≠ËäÇÁÇπ
            selectNode(newNode);
            
            // Êõ¥Êñ∞Áº©Áï•Âõæ
            updateMinimapWithImage(newNode);
            
            debugLog(`[Á≤òË¥¥] ÂõæÁâá: ${newNode.dataset.filename}`, 'info');
        }

        function createTextNode(text, prompt = '', index = 0) {
            const node = document.createElement('div');
            node.className = 'canvas-node text-node';
            node.dataset.index = index;
            node.dataset.filename = `Text ${index + 1}`;
            node.dataset.nodeType = 'text';
            
            const promptElement = document.createElement('div');
            promptElement.className = 'text-prompt';
            promptElement.textContent = prompt || 'ÊñáÊú¨ÂõûÂ§ç';
            
            const textContent = document.createElement('div');
            textContent.className = 'text-content';
            textContent.textContent = text;
            
            const toolbar = document.createElement('div');
            toolbar.className = 'node-toolbar';
            
            const copyPromptBtn = document.createElement('button');
            copyPromptBtn.className = 'toolbar-btn';
            copyPromptBtn.innerHTML = 'üìù';
            copyPromptBtn.title = 'Â§çÂà∂ÊèêÁ§∫ËØç';
            copyPromptBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                navigator.clipboard.writeText(prompt || '').then(() => {
                    if (showMouseLogs) {
                        debugLog(`[Â§çÂà∂] ÊèêÁ§∫ËØç: ${node.dataset.filename}`, 'info');
                    }
                });
            });
            
            const copyBtn = document.createElement('button');
            copyBtn.className = 'toolbar-btn';
            copyBtn.innerHTML = 'üìã';
            copyBtn.title = 'Â§çÂà∂ÊñáÊú¨';
            copyBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                navigator.clipboard.writeText(text).then(() => {
                    if (showMouseLogs) {
                        debugLog(`[Â§çÂà∂] ÊñáÊú¨ËäÇÁÇπ: ${node.dataset.filename}`, 'info');
                    }
                });
            });
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'toolbar-btn';
            deleteBtn.innerHTML = 'üóëÔ∏è';
            deleteBtn.title = 'Âà†Èô§ËäÇÁÇπ';
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                selectNode(node);
                deleteSelectedNode();
            });
            
            toolbar.appendChild(copyPromptBtn);
            toolbar.appendChild(copyBtn);
            toolbar.appendChild(deleteBtn);
            
            node.appendChild(promptElement);
            node.appendChild(textContent);
            node.appendChild(toolbar);
            
            node.style.left = '5000px';
            node.style.top = '5000px';
            
            node.addEventListener('mousedown', (e) => {
                if (e.button === 0 && !e.target.closest('.toolbar-btn')) {
                    if (showMouseLogs) {
                        debugLog(`[ÂºÄÂßãÊãñÂä®] ÊñáÊú¨ËäÇÁÇπ: ${node.dataset.filename}`, 'info');
                    }
                    selectNode(node);
                    AppState.isDraggingNode = true;
                    AppState.dragNode = node;
                    AppState.dragStartX = e.clientX;
                    AppState.dragStartY = e.clientY;
                    AppState.dragNodeStartLeft = parseInt(node.style.left) || 5000;
                    AppState.dragNodeStartTop = parseInt(node.style.top) || 5000;
                    node.style.cursor = 'grabbing';
                    e.preventDefault();
                }
            });
            
            return node;
        }

        function addSampleImage() {
            let svgContent = '<svg xmlns="http://www.w3.org/2000/svg" width="500" height="500" viewBox="0 0 500 500">';
            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E9', '#F8B500', '#00CED1', '#FF69B4', '#32CD32', '#FFD700', '#FF6347', '#7B68EE', '#20B2AA', '#FFA500', '#9370DB', '#DC143C', '#00FA9A', '#FF1493', '#00BFFF', '#FF4500'];
            
            let colorIndex = 0;
            for (let row = 1; row <= 5; row++) {
                for (let col = 1; col <= 5; col++) {
                    const x = (col - 1) * 100;
                    const y = (row - 1) * 100;
                    const color = colors[colorIndex % colors.length];
                    
                    svgContent += `<rect x="${x}" y="${y}" width="100" height="100" fill="${color}" stroke="#fff" stroke-width="2"/>`;
                    svgContent += `<text x="${x + 50}" y="${y + 50}" dominant-baseline="middle" text-anchor="middle" font-size="20" font-weight="bold" fill="#fff" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">${row}.${col}</text>`;
                    
                    colorIndex++;
                }
            }
            
            svgContent += '</svg>';
            const sampleImageUrl = `data:image/svg+xml,${encodeURIComponent(svgContent)}`;
            
            const existingSample = imageResponseContainer.querySelector('[data-filename="sample_image.png"]');
            if (existingSample) {
                console.log('Sample image already exists, skipping...');
                return;
            }
            
            const node = createImageNode(sampleImageUrl, '5x5 ÁΩëÊ†º', nodeCounter++, 'sample_image.png', '500x500');
            imageResponseContainer.appendChild(node);
        }

        function createTextLoadingPlaceholder(prompt, x, y) {
            const node = document.createElement('div');
            node.className = 'canvas-node text-loading-placeholder';
            node.dataset.index = nodeCounter++;
            node.dataset.filename = 'Loading...';
            node.style.left = `${x}px`;
            node.style.top = `${y}px`;
            
            const loadingText = document.createElement('div');
            loadingText.className = 'loading-text';
            loadingText.textContent = 'Ê≠£Âú®ÁîüÊàêÂõûÂ§ç...';
            
            node.appendChild(loadingText);
            
            // Ê∑ªÂä†Èº†Ê†áÊåâ‰∏ã‰∫ã‰ª∂ÔºåÁ°Æ‰øùÂèØ‰ª•ÊãñÂä®
            node.addEventListener('mousedown', (e) => {
                if (e.button === 0 && !e.ctrlKey && !e.metaKey) {
                    e.stopPropagation();
                    selectNode(node);
                    
                    // ËÆæÁΩÆÂÖ®Â±ÄÊãñÂä®Áä∂ÊÄÅ
                    AppState.isDraggingNode = true;
                    AppState.dragNode = node;
                    AppState.activeNode = node;
                    
                    // ËÆ∞ÂΩïÂàùÂßã‰ΩçÁΩÆ
                    AppState.dragStartX = e.clientX;
                    AppState.dragStartY = e.clientY;
                    AppState.dragNodeStartLeft = parseInt(node.style.left || '0');
                    AppState.dragNodeStartTop = parseInt(node.style.top || '0');
                }
            });
            
            return node;
        }
        
        function updateTextLoadingPlaceholder(node, text, prompt) {
            node.classList.remove('text-loading-placeholder');
            node.classList.add('text-node');
            node.dataset.filename = `Text ${node.dataset.index}`;
            node.dataset.nodeType = 'text';
            
            const loadingText = node.querySelector('.loading-text');
            if (loadingText) {
                loadingText.remove();
            }
            
            const promptElement = document.createElement('div');
            promptElement.className = 'text-prompt';
            promptElement.textContent = prompt || 'ÊñáÊú¨ÂõûÂ§ç';
            
            const textContent = document.createElement('div');
            textContent.className = 'text-content';
            textContent.textContent = text;
            
            const toolbar = document.createElement('div');
            toolbar.className = 'node-toolbar';
            
            const copyPromptBtn = document.createElement('button');
            copyPromptBtn.className = 'toolbar-btn';
            copyPromptBtn.innerHTML = 'üìù';
            copyPromptBtn.title = 'Â§çÂà∂ÊèêÁ§∫ËØç';
            copyPromptBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                navigator.clipboard.writeText(prompt || '').then(() => {
                    if (showMouseLogs) {
                        debugLog(`[Â§çÂà∂] ÊèêÁ§∫ËØç: ${node.dataset.filename}`, 'info');
                    }
                });
            });
            
            const copyBtn = document.createElement('button');
            copyBtn.className = 'toolbar-btn';
            copyBtn.innerHTML = 'üìã';
            copyBtn.title = 'Â§çÂà∂ÊñáÊú¨';
            copyBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                navigator.clipboard.writeText(text).then(() => {
                    if (showMouseLogs) {
                        debugLog(`[Â§çÂà∂] ÊñáÊú¨ËäÇÁÇπ: ${node.dataset.filename}`, 'info');
                    }
                });
            });
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'toolbar-btn';
            deleteBtn.innerHTML = 'üóëÔ∏è';
            deleteBtn.title = 'Âà†Èô§ËäÇÁÇπ';
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                selectNode(node);
                deleteSelectedNode();
            });
            
            toolbar.appendChild(copyPromptBtn);
            toolbar.appendChild(copyBtn);
            toolbar.appendChild(deleteBtn);
            
            node.appendChild(promptElement);
            node.appendChild(textContent);
            node.appendChild(toolbar);
            
            node.addEventListener('mousedown', (e) => {
                if (e.button === 0 && !e.target.closest('.toolbar-btn')) {
                    if (showMouseLogs) {
                        debugLog(`[ÂºÄÂßãÊãñÂä®] ÊñáÊú¨ËäÇÁÇπ: ${node.dataset.filename}`, 'info');
                    }
                    selectNode(node);
                    AppState.isDraggingNode = true;
                    AppState.dragNode = node;
                    AppState.dragStartX = e.clientX;
                    AppState.dragStartY = e.clientY;
                    AppState.dragNodeStartLeft = parseInt(node.style.left) || 5000;
                    AppState.dragNodeStartTop = parseInt(node.style.top) || 5000;
                    node.style.cursor = 'grabbing';
                    e.preventDefault();
                }
            });
        }

        function createLoadingPlaceholder(width, height, x, y) {
            const node = document.createElement('div');
            node.className = 'canvas-node loading-placeholder';
            node.dataset.index = nodeCounter++;
            node.dataset.filename = 'Loading...';
            node.style.width = `${width}px`;
            node.style.height = `${height}px`;
            node.style.left = `${x}px`;
            node.style.top = `${y}px`;
            
            // Ê∑ªÂä†Âä†ËΩΩÂä®Áîª
            const loadingContainer = document.createElement('div');
            loadingContainer.className = 'loading-container';
            loadingContainer.style.width = '100%';
            loadingContainer.style.height = '100%';
            loadingContainer.style.display = 'flex';
            loadingContainer.style.flexDirection = 'column';
            loadingContainer.style.justifyContent = 'center';
            loadingContainer.style.alignItems = 'center';
            loadingContainer.style.backgroundColor = '#f3f4f6';
            loadingContainer.style.borderRadius = '8px';
            loadingContainer.style.border = '1px solid #e5e7eb';
            
            const loadingBar = document.createElement('div');
            loadingBar.className = 'loading-bar';
            loadingBar.style.width = '60%';
            loadingBar.style.height = '4px';
            loadingBar.style.backgroundColor = '#e5e7eb';
            loadingBar.style.borderRadius = '2px';
            loadingBar.style.overflow = 'hidden';
            
            const loadingProgress = document.createElement('div');
            loadingProgress.className = 'loading-progress';
            loadingProgress.style.width = '100%';
            loadingProgress.style.height = '100%';
            loadingProgress.style.backgroundColor = '#3b82f6';
            loadingProgress.style.borderRadius = '2px';
            loadingProgress.style.animation = 'loading 1.5s ease-in-out infinite';
            
            const loadingText = document.createElement('div');
            loadingText.className = 'loading-text';
            loadingText.textContent = 'Ê≠£Âú®ÁîüÊàêÂõæÁâá...';
            loadingText.style.marginTop = '12px';
            loadingText.style.fontSize = '14px';
            loadingText.style.color = '#6b7280';
            
            loadingBar.appendChild(loadingProgress);
            loadingContainer.appendChild(loadingBar);
            loadingContainer.appendChild(loadingText);
            
            // Ê∑ªÂä†Â§¥ÈÉ®‰ø°ÊÅØ
            const header = document.createElement('div');
            header.className = 'node-header';
            
            const filenameElement = document.createElement('div');
            filenameElement.className = 'node-filename';
            filenameElement.textContent = 'Loading...';
            
            const resolutionElement = document.createElement('div');
            resolutionElement.className = 'node-resolution';
            resolutionElement.textContent = 'Generating...';
            
            header.appendChild(filenameElement);
            header.appendChild(resolutionElement);
            
            // ÂàõÂª∫ÊÇ¨ÊµÆÂ∑•ÂÖ∑Ê†è
            const toolbar = document.createElement('div');
            toolbar.className = 'node-toolbar';
            
            // Ê∑ªÂä†Â§çÂà∂ÊèêÁ§∫ËØçÊåâÈíÆ
            const copyPromptBtn = document.createElement('button');
            copyPromptBtn.className = 'toolbar-btn';
            copyPromptBtn.innerHTML = 'üìù';
            copyPromptBtn.title = 'Â§çÂà∂ÊèêÁ§∫ËØç';
            copyPromptBtn.disabled = true;
            copyPromptBtn.style.opacity = '0.5';
            
            // Ê∑ªÂä†ÊèíÂÖ•Âà∞ËæìÂÖ•Ê°ÜÊåâÈíÆ
            const insertBtn = document.createElement('button');
            insertBtn.className = 'toolbar-btn';
            insertBtn.innerHTML = '‚úèÔ∏è';
            insertBtn.title = 'ÊèíÂÖ•Âà∞ËæìÂÖ•Ê°Ü';
            insertBtn.disabled = true;
            insertBtn.style.opacity = '0.5';
            
            // Ê∑ªÂä†Â§çÂà∂ÊåâÈíÆ
            const copyBtn = document.createElement('button');
            copyBtn.className = 'toolbar-btn';
            copyBtn.innerHTML = 'üìã';
            copyBtn.title = 'Â§çÂà∂ÂõæÁâá';
            copyBtn.disabled = true;
            copyBtn.style.opacity = '0.5';
            
            // Ê∑ªÂä†Âà†Èô§ÊåâÈíÆ
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'toolbar-btn';
            deleteBtn.innerHTML = 'üóëÔ∏è';
            deleteBtn.title = 'Âà†Èô§ÂõæÁâá';
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (confirm('Á°ÆÂÆöË¶ÅÂèñÊ∂àÁîüÊàêÂêóÔºü')) {
                    const minimapImage = minimapCanvas.querySelector(`[data-node-id="${node.dataset.index}"]`);
                    if (minimapImage) {
                        minimapImage.remove();
                    }
                    node.remove();
                }
            });
            
            toolbar.appendChild(copyPromptBtn);
            toolbar.appendChild(insertBtn);
            toolbar.appendChild(copyBtn);
            toolbar.appendChild(deleteBtn);
            
            const info = document.createElement('div');
            info.className = 'node-info';
            info.textContent = 'Loading...';
            
            node.appendChild(header);
            node.appendChild(toolbar);
            node.appendChild(loadingContainer);
            node.appendChild(info);
            
            // Ê∑ªÂä†Èº†Ê†áÊåâ‰∏ã‰∫ã‰ª∂ÔºåÁ°Æ‰øùÂèØ‰ª•ÊãñÂä®
            node.addEventListener('mousedown', (e) => {
                if (e.button === 0 && !e.ctrlKey && !e.metaKey) {
                    e.stopPropagation();
                    selectNode(node);
                    
                    // ËÆæÁΩÆÂÖ®Â±ÄÊãñÂä®Áä∂ÊÄÅ
                    AppState.isDraggingNode = true;
                    AppState.dragNode = node;
                    AppState.activeNode = node;
                    
                    // ËÆ∞ÂΩïÂàùÂßã‰ΩçÁΩÆ
                    AppState.dragStartX = e.clientX;
                    AppState.dragStartY = e.clientY;
                    AppState.dragNodeStartLeft = parseInt(node.style.left || '0');
                    AppState.dragNodeStartTop = parseInt(node.style.top || '0');
                }
            });
            
            return node;
        }
        
        function updateLoadingPlaceholder(node, imageUrl, prompt, filename, resolution) {
            // Êõ¥Êñ∞ËäÇÁÇπÂ±ûÊÄß
            node.classList.remove('loading-placeholder');
            node.dataset.imageUrl = imageUrl;
            node.dataset.filename = filename || `Image ${node.dataset.index}`;
            
            // Ê∏ÖÈô§Âõ∫ÂÆöÁöÑÂÆΩÈ´òÊ†∑ÂºèÔºåËÆ©ÂõæÁâáÊ≠£Â∏∏ÊòæÁ§∫
            node.style.width = '';
            node.style.height = '';
            
            // ÁßªÈô§Âä†ËΩΩÂä®Áîª
            const loadingContainer = node.querySelector('.loading-container');
            if (loadingContainer) {
                loadingContainer.remove();
            }
            
            // ÂàõÂª∫ÂõæÁâáÂÖÉÁ¥†
            const img = document.createElement('img');
            img.src = imageUrl;
            img.alt = `Generated image ${node.dataset.index}`;
            img.draggable = false;
            
            // Ê∑ªÂä†Ë∞ÉÊï¥Â§ßÂ∞èÊâãÊüÑ
            const resizeHandle = document.createElement('div');
            resizeHandle.className = 'resize-handle';
            
            // ÂàõÂª∫‰∏≠ÂøÉÂùêÊ†áÊòæÁ§∫
            const centerCoords = document.createElement('div');
            centerCoords.className = 'node-center-coords';
            centerCoords.textContent = '(0, 0)';
            
            // Êõ¥Êñ∞Â§¥ÈÉ®‰ø°ÊÅØ
            const filenameElement = node.querySelector('.node-filename');
            if (filenameElement) {
                filenameElement.textContent = filename || `Image ${node.dataset.index}`;
            }
            
            const resolutionElement = node.querySelector('.node-resolution');
            if (resolutionElement) {
                resolutionElement.textContent = resolution || 'Loading...';
            }
            
            // Êõ¥Êñ∞‰ø°ÊÅØÊñáÊú¨
            const info = node.querySelector('.node-info');
            if (info) {
                info.textContent = prompt || `Image ${node.dataset.index}`;
            }
            
            // Êõ¥Êñ∞Â∑•ÂÖ∑Ê†èÊåâÈíÆÁä∂ÊÄÅ
            const toolbarButtons = node.querySelectorAll('.toolbar-btn');
            toolbarButtons.forEach((btn, index) => {
                if (index < 3) { // Ââç‰∏â‰∏™ÊåâÈíÆÔºàÂ§çÂà∂ÊèêÁ§∫ËØç„ÄÅÊèíÂÖ•Âà∞ËæìÂÖ•Ê°Ü„ÄÅÂ§çÂà∂ÂõæÁâáÔºâ
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (index === 0) {
                            // Â§çÂà∂ÊèêÁ§∫ËØçÊåâÈíÆ
                            navigator.clipboard.writeText(prompt || '').then(() => {
                                if (showMouseLogs) {
                                    debugLog(`[Â§çÂà∂] ÊèêÁ§∫ËØç: ${node.dataset.filename}`, 'info');
                                }
                            });
                        } else if (index === 1) {
                            // ÊèíÂÖ•Âà∞ËæìÂÖ•Ê°ÜÊåâÈíÆ
                            const imgElement = node.querySelector('img');
                            if (imgElement) {
                                insertImageToPrompt(imgElement.src, node.dataset.filename || 'Image');
                                debugLog(`[Â∑•ÂÖ∑Ê†è] ÊèíÂÖ•ÂõæÁâáÂà∞ËæìÂÖ•Ê°Ü: node=${node.dataset.filename}`, 'info');
                            }
                        } else if (index === 2) {
                            // Â§çÂà∂ÂõæÁâáÊåâÈíÆ
                            selectNode(node);
                            copySelectedNode();
                            debugLog(`[Â∑•ÂÖ∑Ê†è] Â§çÂà∂ÂõæÁâá: node=${node.dataset.filename}`, 'info');
                        }
                    });
                }
            });
            
            // Ê∑ªÂä†ÂõæÁâáÂä†ËΩΩÂÆåÊàê‰∫ã‰ª∂
            img.onload = function() {
                const actualWidth = this.naturalWidth || parseInt(this.style.width) || 500;
                const actualHeight = this.naturalHeight || parseInt(this.style.height) || 500;
                
                // Êõ¥Êñ∞ÂàÜËæ®ÁéáÊòæÁ§∫
                const resolutionText = `${actualWidth}x${actualHeight}`;
                const resolutionElement = node.querySelector('.node-resolution');
                if (resolutionElement) {
                    resolutionElement.textContent = resolutionText;
                }
                
                // Êõ¥Êñ∞ËäÇÁÇπÊï∞ÊçÆ
                node.dataset.width = actualWidth;
                node.dataset.height = actualHeight;
                
                // Êõ¥Êñ∞ÂõæÁâá‰∏≠ÂøÉÂùêÊ†á
                updateImageCenterCoordinates(node);
                
                // Êõ¥Êñ∞Áº©Áï•Âõæ
                updateMinimapWithImage(node);
            };
            
            // ÊèíÂÖ•ÂõæÁâá„ÄÅË∞ÉÊï¥Â§ßÂ∞èÊâãÊüÑÂíå‰∏≠ÂøÉÂùêÊ†á
            const header = node.querySelector('.node-header');
            const toolbar = node.querySelector('.node-toolbar');
            const infoElement = node.querySelector('.node-info');
            
            if (header && toolbar && infoElement) {
                // Ê∏ÖÁ©∫ËäÇÁÇπÂÜÖÂÆπÔºå‰øùÁïôÂ§¥ÈÉ®ÂíåÂ∑•ÂÖ∑Ê†è
                const children = [...node.children];
                children.forEach(child => {
                    if (child !== header && child !== toolbar && child !== infoElement) {
                        child.remove();
                    }
                });
                
                // ÊèíÂÖ•ÂõæÁâá„ÄÅË∞ÉÊï¥Â§ßÂ∞èÊâãÊüÑÂíå‰∏≠ÂøÉÂùêÊ†á
                node.insertBefore(img, infoElement);
                node.insertBefore(resizeHandle, infoElement);
                node.insertBefore(centerCoords, infoElement);
            }
            
            // Ê∑ªÂä†Ë∞ÉÊï¥Â§ßÂ∞èÂäüËÉΩ
            resizeHandle.addEventListener('mousedown', (e) => {
                e.stopPropagation();
                AppState.isResizingNode = true;
                AppState.resizeNode = node;
                AppState.resizeStart = {
                    x: e.clientX,
                    y: e.clientY,
                    width: img.width,
                    height: img.height
                };
                document.body.style.cursor = 'nwse-resize';
            });
            
            // Ê∑ªÂä†Âè≥ÈîÆËèúÂçïÂäüËÉΩ
            node.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                const img = node.querySelector('img');
                showImageContextMenu(e, node, img);
            });
            
            // Ê∑ªÂä†PINÂäüËÉΩ
            img.addEventListener('click', (e) => {
                e.stopPropagation();
                if (e.ctrlKey || e.metaKey) {
                    if (node.classList.contains('selected')) {
                        addPinToImage(node, e);
                    }
                }
            });
            
            // ÂàùÂßãÂåñPINÊï∞ÊçÆ
            node.dataset.pins = JSON.stringify([]);
            
            // ÈÄâ‰∏≠ËäÇÁÇπ
            selectNode(node);
            
            // Êõ¥Êñ∞Áº©Áï•Âõæ
            updateMinimapWithImage(node);
            
            return node;
        }
        
        function openModal(blobUrl) {
            currentBlobUrl = blobUrl;
            modalImage.src = blobUrl;
            imageModal.classList.remove('hidden');
            imageModal.classList.add('flex');
        }

        function closeModal() {
            imageModal.classList.add('hidden');
            imageModal.classList.remove('flex');
        }

        closeModalBtn.addEventListener('click', closeModal);
        closeModalBtn2.addEventListener('click', closeModal);
        imageModal.addEventListener('click', (e) => {
            if (e.target === imageModal) {
                closeModal();
            }
        });

        downloadModalBtn.addEventListener('click', () => {
            if (currentBlobUrl) {
                const link = document.createElement('a');
                link.href = currentBlobUrl;
                link.download = `gemini-generated-${Date.now()}.png`;
                link.click();
            }
        });

        openFolderBtn.addEventListener('click', async () => {
            try {
                const response = await fetch('/open-folder', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });
                const result = await response.json();
                if (result.success) {
                    alert(`${result.message}\n\nËØ∑Â§çÂà∂Ë∑ØÂæÑÂπ∂Âú®Êñá‰ª∂ËµÑÊ∫êÁÆ°ÁêÜÂô®‰∏≠ÊâìÂºÄ`);
                    navigator.clipboard.writeText(result.path).then(() => {
                        console.log('Ë∑ØÂæÑÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');
                    }).catch(err => {
                        console.error('Â§çÂà∂Â§±Ë¥•:', err);
                    });
                } else {
                    alert('ÊâìÂºÄÊñá‰ª∂Â§πÂ§±Ë¥•: ' + result.error);
                }
            } catch (error) {
                alert('ÊâìÂºÄÊñá‰ª∂Â§πÂ§±Ë¥•: ' + error.message);
            }
        });

        apiKeyInput.value = CONFIG.API_KEY;

        function populateModelSelects() {
            TEXT_MODELS.forEach(model => {
                const option = document.createElement('option');
                option.value = model.value;
                option.textContent = model.name;
                if (model.value === CONFIG.MODEL_NAME) {
                    option.selected = true;
                }
                textModelName.appendChild(option);
                
                const visionOption = document.createElement('option');
                visionOption.value = model.value;
                visionOption.textContent = model.name;
                if (model.value === CONFIG.MODEL_NAME) {
                    visionOption.selected = true;
                }
                visionModelName.appendChild(visionOption);
            });

            IMAGE_MODELS.forEach(model => {
                const option = document.createElement('option');
                option.value = model.value;
                option.textContent = model.name;
                if (model.value === CONFIG.IMAGE_MODEL_NAME) {
                    option.selected = true;
                }
                imageModelName.appendChild(option);
            });
        }

        populateModelSelects();

        let imageDataList = [];
        let pasteImageCounter = 0;

        function createImageTag(imageData, index) {
            const item = document.createElement('span');
            item.className = 'pasted-image-item';
            item.style.position = 'relative';
            item.dataset.index = index;
            item.dataset.imageUrl = imageData.data;
            item.dataset.filename = imageData.name;
            item.contentEditable = 'false';
            
            const img = document.createElement('img');
            img.src = imageData.data;
            img.alt = imageData.name;
            
            const nameSpan = document.createElement('span');
            nameSpan.textContent = imageData.name.length > 20 ? imageData.name.substring(0, 20) + '...' : imageData.name;
            nameSpan.title = imageData.name;
            
            const tooltip = document.createElement('div');
            tooltip.className = 'image-preview-tooltip';
            
            const tooltipImg = document.createElement('img');
            tooltipImg.src = imageData.data;
            tooltipImg.alt = imageData.name;
            
            // Ê∑ªÂä†ÂõæÁâáÂä†ËΩΩÂÆåÊàêÂêéÁöÑÂ∞∫ÂØ∏Ë∞ÉÊï¥
            tooltipImg.onload = function() {
                const naturalWidth = this.naturalWidth;
                const naturalHeight = this.naturalHeight;
                
                const maxWidth = Math.min(window.innerWidth * 0.7, 500);
                const maxHeight = Math.min(window.innerHeight * 0.7, 500);
                
                const widthRatio = maxWidth / naturalWidth;
                const heightRatio = maxHeight / naturalHeight;
                const scale = Math.min(widthRatio, heightRatio);
                
                const displayWidth = naturalWidth * scale;
                const displayHeight = naturalHeight * scale;
                
                this.style.width = `${displayWidth}px`;
                this.style.height = `${displayHeight}px`;
            };
            
            tooltip.appendChild(tooltipImg);
            
            item.appendChild(img);
            item.appendChild(nameSpan);
            
            // Â∞Ü tooltip ÊåÇËΩΩÂà∞ÊúÄÂ§ñÂ±Ç body
            document.body.appendChild(tooltip);
            
            // Áî® JS ‰æ¶Âê¨Èº†Ê†áÊÇ¨ÂÅúÔºåÊéßÂà∂ÊòæÁ§∫Âπ∂Ëß¶ÂèëÂÆö‰Ωç
            item.addEventListener('mouseenter', () => {
                tooltip.style.display = 'block';
                // Âª∂Ëøü 10ms Á°Æ‰øù DOM Ê∏≤ÊüìÊãøÂà∞ÁúüÂÆûÂÆΩÈ´ò
                setTimeout(() => adjustTooltipPosition(tooltip, item), 10);
            });
            item.addEventListener('mouseleave', () => {
                tooltip.style.display = 'none';
            });
            
            // ‰øÆÊîπÂà†Èô§ÈÄªËæëÔºåËøûÂêåÂ§ñÂ±ÇÁöÑ tooltip ‰∏ÄËµ∑Âà†Êéâ
            const deleteBtn = document.createElement('span');
            deleteBtn.className = 'delete-btn';
            deleteBtn.textContent = '√ó';
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                const filename = item.dataset.filename;
                tooltip.remove(); // Ê∏ÖÁêÜÊ∏∏Á¶ªÁöÑÂºπÁ™ó
                item.remove();
                updateImageDataList();
                debugLog(`[Âà†Èô§ÂõæÁâá] Êñá‰ª∂Âêç: ${filename}`, 'info');
            };
            
            item.appendChild(deleteBtn);
            
            return item;
        }

        function insertImageToPrompt(imageUrl, filename) {
            const imageData = {
                data: imageUrl,
                name: filename
            };
            imageDataList.push(imageData);
            const imageTag = createImageTag(imageData, pasteImageCounter++);
            promptInput.appendChild(imageTag);
            updateImageDataList();
            debugLog(`[ÊèíÂÖ•ÂõæÁâá] Êñá‰ª∂Âêç: ${filename}`, 'info');
        }

        promptInput.addEventListener('paste', async (e) => {
            debugLog(`[Á≤òË¥¥‰∫ã‰ª∂] Ëß¶Âèë, ÁõÆÊ†á: ${e.target.id || e.target.className}`, 'info');
            const items = e.clipboardData.items;
            debugLog(`[Á≤òË¥¥‰∫ã‰ª∂] Ââ™Ë¥¥ÊùøÈ°πÁõÆÊï∞Èáè: ${items.length}`, 'info');
            
            for (let item of items) {
                debugLog(`[Á≤òË¥¥‰∫ã‰ª∂] È°πÁõÆÁ±ªÂûã: ${item.type}`, 'info');
                if (item.type.indexOf('image') !== -1) {
                    e.preventDefault();
                    
                    const file = item.getAsFile();
                    debugLog(`[Á≤òË¥¥‰∫ã‰ª∂] Ê£ÄÊµãÂà∞ÂõæÁâá, Êñá‰ª∂Âêç: ${file.name || 'Êú™Áü•'}, Á±ªÂûã: ${file.type}, Â§ßÂ∞è: ${file.size} bytes`, 'info');
                    
                    const reader = new FileReader();
                    
                    reader.onload = (event) => {
                        const base64Data = event.target.result;
                        const baseName = file.name || 'image.png';
                        const ext = baseName.includes('.') ? baseName.split('.').pop() : 'png';
                        const uniqueName = `image_${pasteImageCounter + 1}.${ext}`;
                        
                        debugLog(`[Á≤òË¥¥ÂõæÁâá] Base64ÈïøÂ∫¶: ${base64Data.length}, Ââç50Â≠óÁ¨¶: ${base64Data.substring(0, 50)}`, 'info');
                        
                        const imageData = {
                            data: base64Data,
                            name: uniqueName
                        };
                        
                        const imageTag = createImageTag(imageData, imageDataList.length);
                        insertAtCursor(imageTag);
                        updateImageDataList();
                        
                        pasteImageCounter++;
                        
                        debugLog(`[Á≤òË¥¥ÂõæÁâá] Êñá‰ª∂Âêç: ${uniqueName}, Êù•Ê∫ê: Ââ™Ë¥¥Êùø`, 'info');
                    };
                    
                    reader.readAsDataURL(file);
                }
            }
        });
        
        document.addEventListener('paste', (e) => {
            if (!imageGenMode.checked) return;
            
            const isInInput = document.activeElement === promptInput || promptInput.contains(document.activeElement);
            if (isInInput) return;
            
            debugLog(`[ÁîªÂ∏ÉÁ≤òË¥¥] Ëß¶Âèë, ÁõÆÊ†á: ${e.target.id || e.target.className}`, 'info');
            
            const items = e.clipboardData.items;
            let hasImage = false;
            
            for (let item of items) {
                debugLog(`[ÁîªÂ∏ÉÁ≤òË¥¥] È°πÁõÆÁ±ªÂûã: ${item.type}`, 'info');
                if (item.type.indexOf('image') !== -1) {
                    hasImage = true;
                    e.preventDefault();
                    
                    const file = item.getAsFile();
                    debugLog(`[ÁîªÂ∏ÉÁ≤òË¥¥] Ê£ÄÊµãÂà∞ÂõæÁâá, Êñá‰ª∂Âêç: ${file.name || 'Êú™Áü•'}, Á±ªÂûã: ${file.type}, Â§ßÂ∞è: ${file.size} bytes`, 'info');
                    
                    const reader = new FileReader();
                    
                    reader.onload = (event) => {
                        const base64Data = event.target.result;
                        const baseName = file.name || 'image.png';
                        const ext = baseName.includes('.') ? baseName.split('.').pop() : 'png';
                        const uniqueName = `pasted_${Date.now()}.${ext}`;
                        
                        debugLog(`[ÁîªÂ∏ÉÁ≤òË¥¥] ÂàõÂª∫ËäÇÁÇπ: ${uniqueName}`, 'info');
                        
                        const node = createImageNode(base64Data, 'Á≤òË¥¥ÂõæÁâá', nodeCounter++, uniqueName, `${file.width || 500}x${file.height || 500}`);
                        imageResponseContainer.appendChild(node);
                        
                        debugLog(`[Á≤òË¥¥] ÂõæÁâá: ${uniqueName}`, 'info');
                    };
                    
                    reader.readAsDataURL(file);
                    break;
                }
            }
            
            if (!hasImage && clipboardNode) {
                e.preventDefault();
                debugLog(`[ÁîªÂ∏ÉÁ≤òË¥¥] ‰ΩøÁî®clipboardNode: ${clipboardNode.dataset.filename}`, 'info');
                pasteNode();
            }
        });

        function insertAtCursor(node) {
            const selection = window.getSelection();
            
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                
                const parent = promptInput;
                if (parent.contains(range.commonAncestorContainer) || parent === range.commonAncestorContainer) {
                    range.deleteContents();
                    
                    const spaceBefore = document.createTextNode(' ');
                    const spaceAfter = document.createTextNode(' ');
                    
                    range.insertNode(spaceBefore);
                    range.insertNode(node);
                    range.insertNode(spaceAfter);
                    
                    const newRange = document.createRange();
                    newRange.setStartAfter(node);
                    newRange.collapse(true);
                    selection.removeAllRanges();
                    selection.addRange(newRange);
                } else {
                    const spaceBefore = document.createTextNode(' ');
                    const spaceAfter = document.createTextNode(' ');
                    promptInput.appendChild(spaceBefore);
                    promptInput.appendChild(node);
                    promptInput.appendChild(spaceAfter);
                    
                    const newRange = document.createRange();
                    newRange.setStartAfter(node);
                    newRange.collapse(true);
                    selection.removeAllRanges();
                    selection.addRange(newRange);
                }
            } else {
                const spaceBefore = document.createTextNode(' ');
                const spaceAfter = document.createTextNode(' ');
                promptInput.appendChild(spaceBefore);
                promptInput.appendChild(node);
                promptInput.appendChild(spaceAfter);
                
                const newRange = document.createRange();
                newRange.setStartAfter(node);
                newRange.collapse(true);
                selection.removeAllRanges();
                selection.addRange(newRange);
            }
            
            promptInput.focus();
        }

        function updateImageDataList() {
            imageDataList = [];
            const imageTags = promptInput.querySelectorAll('.pasted-image-item');
            imageTags.forEach((tag, index) => {
                imageDataList.push({
                    data: tag.dataset.imageUrl,
                    name: tag.dataset.filename
                });
                tag.dataset.index = index;
            });
        }

        function addCanvasImageToPrompt(node) {
            const imageUrl = node.dataset.imageUrl;
            const filename = node.dataset.filename;
            
            if (!imageUrl || node.classList.contains('loading-placeholder') || filename === 'Loading...') {
                alert('Êó†Ê≥ïÊèíÂÖ•Ê≠£Âú®ÁîüÊàêÁöÑÂõæÁâáÔºåËØ∑Á≠âÂæÖÂõæÁâáÁîüÊàêÂÆåÊàêÂêéÂÜçËØï');
                return;
            }
            
            const existingTags = promptInput.querySelectorAll('.pasted-image-item');
            for (let tag of existingTags) {
                if (tag.dataset.imageUrl === imageUrl) {
                    return;
                }
            }
            
            const img = node.querySelector('img');
            if (!img) {
                alert('Êó†Ê≥ïËé∑ÂèñÂõæÁâáÊï∞ÊçÆ');
                return;
            }
            
            let imageDataUrl;
            if (img.src.startsWith('data:')) {
                imageDataUrl = img.src;
            } else {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = img.naturalWidth || img.width;
                canvas.height = img.naturalHeight || img.height;
                
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                imageDataUrl = canvas.toDataURL('image/png');
            }
            
            const imageData = {
                data: imageDataUrl,
                name: filename
            };
            
            const imageTag = createImageTag(imageData, imageDataList.length);
            insertAtCursor(imageTag);
            updateImageDataList();
            
            debugLog(`[ÊèíÂÖ•ÂõæÁâá] Êñá‰ª∂Âêç: ${filename}, Êï∞ÊçÆÊ†ºÂºè: ${imageDataUrl.startsWith('data:') ? 'Base64' : 'URL'}`, 'info');
        }

        async function drawPinsOnImage(imageUrl, pins) {
            return new Promise((resolve) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.naturalWidth || img.width;
                    canvas.height = img.naturalHeight || img.height;
                    const ctx = canvas.getContext('2d');
                    
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    pins.forEach(pin => {
                        const x = pin.x;
                        const y = pin.y;
                        const radius = Math.max(20, Math.min(canvas.width, canvas.height) / 30);
                        
                        ctx.beginPath();
                        ctx.arc(x, y, radius, 0, 2 * Math.PI);
                        ctx.fillStyle = 'rgba(239, 68, 68, 0.9)';
                        ctx.fill();
                        ctx.strokeStyle = 'white';
                        ctx.lineWidth = 3;
                        ctx.stroke();
                        
                        ctx.font = `bold ${radius}px Arial`;
                        ctx.fillStyle = 'white';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(pin.number.toString(), x, y);
                    });
                    
                    const annotatedImageUrl = canvas.toDataURL('image/png');
                    resolve(annotatedImageUrl);
                };
                img.onerror = () => {
                    resolve(imageUrl);
                };
                img.src = imageUrl;
            });
        }

        function addPinToImage(node, event) {
            const img = node.querySelector('img');
            const rect = img.getBoundingClientRect();
            
            const naturalWidth = img.naturalWidth;
            const naturalHeight = img.naturalHeight;
            
            const x = ((event.clientX - rect.left) / rect.width) * naturalWidth;
            const y = ((event.clientY - rect.top) / rect.height) * naturalHeight;
            
            const pins = JSON.parse(node.dataset.pins || '[]');
            
            let availableNumber = 1;
            const existingNumbers = new Set(pins.map(p => p.number));
            while (existingNumbers.has(availableNumber)) {
                availableNumber++;
            }
            
            const pin = { id: Date.now(), number: availableNumber, x: x, y: y };
            pins.push(pin);
            pins.sort((a, b) => a.number - b.number);
            node.dataset.pins = JSON.stringify(pins);
            
            createPinMarker(node, pin);
            updatePromptWithPins(node);
            
            debugLog(`[Ê∑ªÂä†PIN] ÂùêÊ†á: (${Math.round(x)}, ${Math.round(y)})`, 'info');
        }

        function createPinMarker(node, pin) {
            const img = node.querySelector('img');
            const naturalWidth = img.naturalWidth;
            const naturalHeight = img.naturalHeight;
            
            const logicalWidth = img.offsetWidth;
            const logicalHeight = img.offsetHeight;
            
            const scaleX = logicalWidth / naturalWidth;
            const scaleY = logicalHeight / naturalHeight;
            
            const displayX = pin.x * scaleX;
            const displayY = pin.y * scaleY;
            
            const marker = document.createElement('div');
            marker.className = 'pin-marker';
            marker.dataset.pinId = pin.id;
            marker.textContent = pin.number;
            
            marker.style.left = `${displayX - 12}px`;
            marker.style.top = `${displayY - 12}px`;
            
            const deleteBtn = document.createElement('div');
            deleteBtn.className = 'pin-delete';
            deleteBtn.textContent = '√ó';
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                removePinFromImage(node, pin.id);
            });
            
            marker.appendChild(deleteBtn);
            node.appendChild(marker);
        }

        function refreshPinsOnNode(node) {
            const pins = JSON.parse(node.dataset.pins || '[]');
            const img = node.querySelector('img');
            if (!img || pins.length === 0) return;
            
            const scaleX = img.offsetWidth / img.naturalWidth;
            const scaleY = img.offsetHeight / img.naturalHeight;

            pins.forEach(pin => {
                const marker = node.querySelector(`.pin-marker[data-pin-id="${pin.id}"]`);
                if (marker) {
                    marker.style.left = `${(pin.x * scaleX) - 12}px`;
                    marker.style.top = `${(pin.y * scaleY) - 12}px`;
                }
            });
        }

        function removePinFromImage(node, pinId) {
            const pins = JSON.parse(node.dataset.pins || '[]');
            const index = pins.findIndex(p => p.id === pinId);
            
            if (index !== -1) {
                const pin = pins[index];
                pins.splice(index, 1);
                node.dataset.pins = JSON.stringify(pins);
                
                const marker = node.querySelector(`.pin-marker[data-pin-id="${pinId}"]`);
                if (marker) {
                    marker.remove();
                }
                
                const tag = promptInput.querySelector(`.pinned-image-tag[data-image-url="${node.dataset.imageUrl}"][data-pin-number="${pin.number}"]`);
                if (tag) {
                    tag.remove();
                }
                
                debugLog(`[Âà†Èô§PIN] ÂõæÁâá: ${node.dataset.filename}, PINÁºñÂè∑: ${pin.number}`, 'info');
            }
        }

        function updatePromptWithPins(node) {
            const pins = JSON.parse(node.dataset.pins || '[]');
            const imageUrl = node.dataset.imageUrl;
            const filename = node.dataset.filename;
            
            const existingTags = promptInput.querySelectorAll('.pinned-image-tag');
            const existingPinNumbers = new Set();
            existingTags.forEach(tag => {
                if (tag.dataset.imageUrl === imageUrl) {
                    existingPinNumbers.add(parseInt(tag.dataset.pinNumber));
                }
            });
            
            pins.forEach(pin => {
                if (!existingPinNumbers.has(pin.number)) {
                    const tag = createPinnedImageTag(imageUrl, filename, pin.number, pin.x, pin.y);
                    insertAtCursor(tag);
                }
            });
        }

        function createPinnedImageTag(imageUrl, filename, pinNumber, pinX, pinY) {
            const tag = document.createElement('span');
            tag.className = 'pinned-image-tag';
            tag.dataset.imageUrl = imageUrl;
            tag.dataset.pinNumber = pinNumber;
            tag.contentEditable = 'false';
            tag.style.userSelect = 'none';
            
            const thumbnail = document.createElement('img');
            thumbnail.src = imageUrl;
            thumbnail.style.width = '24px';
            thumbnail.style.height = '24px';
            thumbnail.style.objectFit = 'cover';
            thumbnail.style.borderRadius = '4px';
            
            const numberBadge = document.createElement('span');
            numberBadge.className = 'pin-number';
            numberBadge.textContent = pinNumber;
            
            const label = document.createElement('span');
            label.className = 'pin-filename';
            label.textContent = `${filename}[${pinNumber}]`;
            
            const tooltip = document.createElement('div');
            tooltip.className = 'image-preview-tooltip';
            
            const tooltipImg = document.createElement('img');
            tooltipImg.src = imageUrl;
            
            const pinIndicator = document.createElement('div');
            pinIndicator.className = 'pin-indicator';
            pinIndicator.textContent = pinNumber;
            
            if (pinX !== undefined && pinY !== undefined) {
                tooltipImg.onload = function() {
                    const naturalWidth = this.naturalWidth;
                    const naturalHeight = this.naturalHeight;
                    
                    const maxWidth = Math.min(window.innerWidth * 0.7, 500);
                    const maxHeight = Math.min(window.innerHeight * 0.7, 500);
                    
                    const widthRatio = maxWidth / naturalWidth;
                    const heightRatio = maxHeight / naturalHeight;
                    const scale = Math.min(widthRatio, heightRatio);
                    
                    const displayWidth = naturalWidth * scale;
                    const displayHeight = naturalHeight * scale;
                    
                    this.style.width = `${displayWidth}px`;
                    this.style.height = `${displayHeight}px`;
                    
                    const indicatorX = pinX * scale;
                    const indicatorY = pinY * scale;
                    
                    pinIndicator.style.left = `${indicatorX}px`;
                    pinIndicator.style.top = `${indicatorY}px`;
                };
            } else {
                tooltipImg.onload = function() {
                    const naturalWidth = this.naturalWidth;
                    const naturalHeight = this.naturalHeight;
                    
                    const maxWidth = Math.min(window.innerWidth * 0.7, 500);
                    const maxHeight = Math.min(window.innerHeight * 0.7, 500);
                    
                    const widthRatio = maxWidth / naturalWidth;
                    const heightRatio = maxHeight / naturalHeight;
                    const scale = Math.min(widthRatio, heightRatio);
                    
                    const displayWidth = naturalWidth * scale;
                    const displayHeight = naturalHeight * scale;
                    
                    this.style.width = `${displayWidth}px`;
                    this.style.height = `${displayHeight}px`;
                };
            }
            
            tooltip.appendChild(tooltipImg);
            tooltip.appendChild(pinIndicator);
            
            tag.appendChild(thumbnail);
            tag.appendChild(numberBadge);
            tag.appendChild(label);
            
            // Â∞Ü tooltip ÊåÇËΩΩÂà∞ÊúÄÂ§ñÂ±Ç body
            document.body.appendChild(tooltip);
            
            // Áî® JS ‰æ¶Âê¨Èº†Ê†áÊÇ¨ÂÅúÔºåÊéßÂà∂ÊòæÁ§∫Âπ∂Ëß¶ÂèëÂÆö‰Ωç
            tag.addEventListener('mouseenter', () => {
                tooltip.style.display = 'block';
                // Âª∂Ëøü 10ms Á°Æ‰øù DOM Ê∏≤ÊüìÊãøÂà∞ÁúüÂÆûÂÆΩÈ´ò
                setTimeout(() => adjustTooltipPosition(tooltip, tag), 10);
            });
            tag.addEventListener('mouseleave', () => {
                tooltip.style.display = 'none';
            });
            
            // ‰øÆÊîπÂà†Èô§ÈÄªËæëÔºåËøûÂêåÂ§ñÂ±ÇÁöÑ tooltip ‰∏ÄËµ∑Âà†Êéâ
            const deleteBtn = document.createElement('span');
            deleteBtn.className = 'tag-delete';
            deleteBtn.textContent = '√ó';
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const node = findNodeByImageUrl(imageUrl);
                if (node) {
                    const pins = JSON.parse(node.dataset.pins || '[]');
                    const pin = pins.find(p => p.number === pinNumber);
                    if (pin) {
                        const marker = node.querySelector(`.pin-marker[data-pin-id="${pin.id}"]`);
                        if (marker) {
                            marker.remove();
                        }
                        pins.splice(pins.indexOf(pin), 1);
                        node.dataset.pins = JSON.stringify(pins);
                    }
                }
                tooltip.remove(); // Ê∏ÖÁêÜÊ∏∏Á¶ªÁöÑÂºπÁ™ó
                tag.remove();
            });
            
            tag.appendChild(deleteBtn);
            
            return tag;
        }

        function findNodeByImageUrl(imageUrl) {
            const nodes = imageResponseContainer.querySelectorAll('.canvas-node');
            for (let node of nodes) {
                if (node.dataset.imageUrl === imageUrl) {
                    return node;
                }
            }
            return null;
        }

        function showImageContextMenu(e, node, img) {
            const existingMenu = document.querySelector('.context-menu');
            if (existingMenu) {
                existingMenu.remove();
            }
            
            const menu = document.createElement('div');
            menu.className = 'context-menu';
            menu.style.left = `${e.clientX}px`;
            menu.style.top = `${e.clientY}px`;
            
            const copyItem = document.createElement('div');
            copyItem.className = 'context-menu-item';
            copyItem.textContent = 'Â§çÂà∂ÂõæÁâá';
            copyItem.addEventListener('click', () => {
                if (img.src.startsWith('data:')) {
                    navigator.clipboard.writeText(img.src).then(() => {
                        console.log('ÂõæÁâáÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');
                    }).catch(err => {
                        console.error('Â§çÂà∂Â§±Ë¥•:', err);
                    });
                } else {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.naturalWidth || img.width;
                    canvas.height = img.naturalHeight || img.height;
                    
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    canvas.toBlob((blob) => {
                        navigator.clipboard.write([
                            new ClipboardItem({
                                'image/png': blob
                            })
                        ]).then(() => {
                            console.log('ÂõæÁâáÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');
                        }).catch(err => {
                            console.error('Â§çÂà∂Â§±Ë¥•:', err);
                        });
                    });
                }
                menu.remove();
            });
            
            const downloadItem = document.createElement('div');
            downloadItem.className = 'context-menu-item';
            downloadItem.textContent = '‰∏ãËΩΩÂõæÁâá';
            downloadItem.addEventListener('click', () => {
                const filename = node.dataset.filename || 'image.png';
                const link = document.createElement('a');
                link.href = img.src;
                link.download = filename;
                link.click();
                menu.remove();
            });
            
            const insertItem = document.createElement('div');
            insertItem.className = 'context-menu-item';
            insertItem.textContent = 'ÊèíÂÖ•Âà∞ËæìÂÖ•Ê°Ü';
            insertItem.addEventListener('click', () => {
                addCanvasImageToPrompt(node);
                menu.remove();
            });
            
            menu.appendChild(copyItem);
            menu.appendChild(downloadItem);
            menu.appendChild(insertItem);
            document.body.appendChild(menu);
            
            setTimeout(() => {
                document.addEventListener('click', (clickEvent) => {
                    if (!menu.contains(clickEvent.target)) {
                        menu.remove();
                    }
                }, { once: true });
            }, 100);
        }

        function adjustTooltipPosition(tooltip, targetElement) {
            if (!tooltip || !targetElement) return;
            
            // Ëé∑ÂèñËæìÂÖ•Ê°ÜÊ†áÁ≠æÁöÑÁªùÂØπ‰ΩçÁΩÆ
            const targetRect = targetElement.getBoundingClientRect();
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;
            
            // Ëé∑ÂèñÈ¢ÑËßàÂõæÁöÑÂÆûÈôÖÂÆΩÈ´ò
            const tooltipRect = tooltip.getBoundingClientRect();
            const tooltipWidth = tooltipRect.width || 300;
            const tooltipHeight = tooltipRect.height || 300;
            
            // Ê†∏ÂøÉÈÄªËæëÔºöÂº∫Âà∂Èù†Â∑¶ - Ê†áÁ≠æÂ∑¶ËæπÁºò ÂáèÂéª È¢ÑËßàÂõæÂÆΩÂ∫¶ ÂáèÂéª 12px Èó¥Ë∑ù
            let left = targetRect.left - tooltipWidth - 12;
            
            // ÂûÇÁõ¥ÊñπÂêëÔºö‰∏éÊ†áÁ≠æÂ±Ö‰∏≠ÂØπÈΩê
            let top = targetRect.top + (targetRect.height / 2) - (tooltipHeight / 2);
            
            // Èò≤ÁøªËΩ¶ËæπÁïåÊ£ÄÊµã
            if (left < 10) {
                // Â¶ÇÊûúÂ∑¶ËæπÂ±èÂπïÁ©∫Èó¥‰∏çÂ§üÔºåÂ¶•Âçè‰∏Ä‰∏ãÊîæÂà∞Âè≥Ëæπ
                left = targetRect.right + 12;
            }
            if (top < 10) top = 10;
            if (top + tooltipHeight > windowHeight - 10) {
                top = windowHeight - tooltipHeight - 10;
            }
            
            // Â∫îÁî®ÊúÄÁªàÂùêÊ†á
            tooltip.style.left = `${left}px`;
            tooltip.style.top = `${top}px`;
        }

        imageGenMode.addEventListener('change', () => {
            console.log('Image gen mode changed:', imageGenMode.checked);
            if (imageGenMode.checked) {
                imageResponseContainer.style.display = 'block';
                responseOutput.style.display = 'none';
            } else {
                imageResponseContainer.style.display = 'block';
                responseOutput.style.display = 'none';
            }
        });

        if (imageGenMode.checked) {
            imageResponseContainer.style.display = 'block';
            responseOutput.style.display = 'none';
        } else {
            imageResponseContainer.style.display = 'block';
            responseOutput.style.display = 'none';
        }

        temperature.addEventListener('input', () => {
            temperatureValue.textContent = temperature.value;
        });

        topP.addEventListener('input', () => {
            topPValue.textContent = topP.value;
        });

        async function testApiKey() {
            const apiKey = CONFIG.API_KEY.trim();
            
            if (!apiKey || apiKey === "YOUR_API_KEY_HERE") {
                apiStatus.innerHTML = '<span class="text-red-600">ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑ API Key</span>';
                return;
            }

            testApiKeyBtn.disabled = true;
            testLoader.classList.remove('hidden');
            apiStatus.innerHTML = '<span class="text-blue-600">Ê≠£Âú®È™åËØÅ API Key...</span>';

            try {
                const genAI = new GoogleGenerativeAI(apiKey);
                const model = genAI.getGenerativeModel({ model: CONFIG.MODEL_NAME });
                
                const result = await model.generateContent("test");
                await result.response;
                
                apiStatus.innerHTML = '<span class="text-green-600">‚úì API Key È™åËØÅÊàêÂäü</span>';
            } catch (error) {
                console.error(error);
                apiStatus.innerHTML = '<span class="text-red-600">‚úó API Key Êó†Êïà: ' + error.message + '</span>';
            } finally {
                testApiKeyBtn.disabled = false;
                testLoader.classList.add('hidden');
            }
        }

        async function saveApiKey() {
            const apiKey = CONFIG.API_KEY.trim();
            
            if (!apiKey || apiKey === "YOUR_API_KEY_HERE") {
                apiStatus.innerHTML = '<span class="text-red-600">ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑ API Key</span>';
                return;
            }

            try {
                const saveEnvResponse = await fetch('/save-env', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        apiKey: apiKey,
                        modelName: textModelName.value,
                        imageModelName: imageModelName.value
                    })
                });
                
                const saveEnvResult = await saveEnvResponse.json();
                
                if (saveEnvResult.success) {
                    const reloadEnvResponse = await fetch('/reload-env', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const reloadEnvResult = await reloadEnvResponse.json();
                    
                    if (reloadEnvResult.success) {
                        CONFIG.API_KEY = apiKey;
                        CONFIG.MODEL_NAME = textModelName.value;
                        CONFIG.IMAGE_MODEL_NAME = imageModelName.value;
                        apiStatus.innerHTML = '<span class="text-green-600">‚úì API Key Â∑≤‰øùÂ≠òÂà∞ÊúçÂä°Âô®</span>';
                    } else {
                        apiStatus.innerHTML = '<span class="text-yellow-600">‚úì API Key Â∑≤‰øùÂ≠òÔºå‰ΩÜÁéØÂ¢ÉÂèòÈáèÈáçËΩΩÂ§±Ë¥•: ' + reloadEnvResult.error + '</span>';
                    }
                } else {
                    apiStatus.innerHTML = '<span class="text-red-600">‚úó ‰øùÂ≠òÂ§±Ë¥•: ' + saveEnvResult.error + '</span>';
                }
            } catch (error) {
                console.error(error);
                apiStatus.innerHTML = '<span class="text-red-600">‚úó ‰øùÂ≠òÂ§±Ë¥•: ' + error.message + '</span>';
            }
        }

        async function clearApiKey() {
            try {
                const clearEnvResponse = await fetch('/clear-env', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const clearEnvResult = await clearEnvResponse.json();
                
                if (clearEnvResult.success) {
                    CONFIG.API_KEY = '';
                    CONFIG.MODEL_NAME = 'gemini-3-flash-preview';
                    CONFIG.IMAGE_MODEL_NAME = 'gemini-3-pro-image-preview';
                    apiKeyInput.value = '';
                    apiStatus.innerHTML = '<span class="text-green-600">‚úì API Key Â∑≤‰ªéÊúçÂä°Âô®Ê∏ÖÈô§</span>';
                } else {
                    apiStatus.innerHTML = '<span class="text-red-600">‚úó Ê∏ÖÈô§Â§±Ë¥•: ' + clearEnvResult.error + '</span>';
                }
            } catch (error) {
                console.error(error);
                apiStatus.innerHTML = '<span class="text-red-600">‚úó Ê∏ÖÈô§Â§±Ë¥•: ' + error.message + '</span>';
            }
        }

        testApiKeyBtn.addEventListener('click', testApiKey);
        document.getElementById('saveApiKeyBtn').addEventListener('click', saveApiKey);
        document.getElementById('clearApiKeyBtn').addEventListener('click', clearApiKey);

        async function callAPI() {
            debugLog(`[ÂºÄÂßãË∞ÉÁî®] callAPI ÂáΩÊï∞`, 'info');
            
            updateImageDataList();
            
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = promptInput.innerHTML;
            const imageTags = tempDiv.querySelectorAll('.pasted-image-item');
            imageTags.forEach(tag => tag.remove());
            
            const pinnedImageTags = tempDiv.querySelectorAll('.pinned-image-tag');
            let processedPrompt = tempDiv.textContent.trim();
            
            const pinInfo = [];
            pinnedImageTags.forEach(tag => {
                const imageUrl = tag.dataset.imageUrl;
                const pinNumber = tag.dataset.pinNumber;
                const filename = tag.querySelector('.pin-filename').textContent;
                
                const node = findNodeByImageUrl(imageUrl);
                if (node) {
                    const pins = JSON.parse(node.dataset.pins || '[]');
                    const pin = pins.find(p => p.number == pinNumber);
                    if (pin) {
                        pinInfo.push({
                            imageUrl: imageUrl,
                            pinNumber: pinNumber,
                            filename: filename,
                            x: pin.x,
                            y: pin.y
                        });
                    }
                }
            });
            
            if (pinInfo.length > 0) {
                pinInfo.forEach(info => {
                    const pinTag = `[${info.pinNumber}]`;
                    if (processedPrompt.includes(pinTag)) {
                        processedPrompt = processedPrompt.replace(pinTag, `[ÂõæÁâá‰∏≠ PIN ${info.pinNumber} Ê†áËÆ∞ÁöÑ‰ΩçÁΩÆ]`);
                    }
                });
            }
            
            const prompt = processedPrompt;
            const apiKey = CONFIG.API_KEY.trim();
            const isImageGenMode = imageGenMode.checked;
            
            debugLog(`[ÂèÇÊï∞Ê£ÄÊü•] ÊèêÁ§∫ËØç: "${prompt}", ÁîüÂõæÊ®°Âºè: ${isImageGenMode}, ÂõæÁâáÊï∞Èáè: ${imageDataList.length}, PINÊï∞Èáè: ${pinInfo.length}`, 'info');
            debugLog(`[API Key] ${apiKey.substring(0, 10)}...`, 'info');
            
            if (!prompt && imageDataList.length === 0 && pinInfo.length === 0) {
                debugLog(`[ÈîôËØØ] ËØ∑ËæìÂÖ•ÂÜÖÂÆπÊàñÁ≤òË¥¥ÂõæÁâá`, 'error');
                return alert("ËØ∑ËæìÂÖ•ÂÜÖÂÆπÊàñÁ≤òË¥¥ÂõæÁâá");
            }
            if (!apiKey || apiKey === "YOUR_API_KEY_HERE") {
                debugLog(`[ÈîôËØØ] ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑ API Key`, 'error');
                return alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑ API Key");
            }

            const genAI = new GoogleGenerativeAI(apiKey);
            
            let modelName;
            if (isImageGenMode) {
                modelName = imageModelName.value;
            } else if (imageDataList.length > 0) {
                modelName = visionModelName.value;
            } else {
                modelName = textModelName.value;
            }
            
            const generationConfig = {
                temperature: parseFloat(temperature.value),
                topP: parseFloat(topP.value),
                topK: 40,
                maxOutputTokens: 8192
            };
            
            if (isImageGenMode) {
                generationConfig.imageConfig = {
                    aspectRatio: aspectRatio.value,
                    imageSize: imageSize.value
                };
            }
            
            const model = genAI.getGenerativeModel({ 
                model: modelName,
                generationConfig: generationConfig
            });

            debugLog(`[Ê®°ÂûãÈÖçÁΩÆ] Ê®°Âûã: ${modelName}, Ê∏©Â∫¶: ${generationConfig.temperature}, TopP: ${generationConfig.topP}`, 'info');
            
            activeRequests++;
            if (activeRequests === 1) {
                loader.classList.remove('hidden');
                if (statusTag) {
                    statusTag.innerText = "ËØ∑Ê±Ç‰∏≠";
                    statusTag.className = "text-xs px-2 py-1 rounded bg-blue-50 text-blue-600";
                }
            }
            debugLog(`[ËØ∑Ê±ÇÁä∂ÊÄÅ] Ê¥ªË∑ÉËØ∑Ê±ÇÊï∞: ${activeRequests}`, 'info');
            responseOutput.classList.remove('italic', 'text-gray-400');
            responseOutput.innerText = "Ê≠£Âú®Â§ÑÁêÜ...";
            imageResponseContainer.classList.remove('hidden');

            let loadingPlaceholder = null;
            if (isImageGenMode) {
                const aspectRatioValue = aspectRatio.value;
                const imageSizeValue = imageSize.value;
                
                let width, height;
                const baseSize = imageSizeValue === '1K' ? 1024 : imageSizeValue === '2K' ? 2048 : 4096;
                
                switch (aspectRatioValue) {
                    case '1:1':
                        width = baseSize;
                        height = baseSize;
                        break;
                    case '16:9':
                        width = baseSize;
                        height = Math.round(baseSize * 9 / 16);
                        break;
                    case '9:16':
                        width = Math.round(baseSize * 9 / 16);
                        height = baseSize;
                        break;
                    case '21:9':
                        width = baseSize;
                        height = Math.round(baseSize * 9 / 21);
                        break;
                    case '4:3':
                        width = baseSize;
                        height = Math.round(baseSize * 3 / 4);
                        break;
                    case '3:4':
                        width = Math.round(baseSize * 3 / 4);
                        height = baseSize;
                        break;
                    case '3:2':
                        width = baseSize;
                        height = Math.round(baseSize * 2 / 3);
                        break;
                    case '2:3':
                        width = Math.round(baseSize * 2 / 3);
                        height = baseSize;
                        break;
                    case '5:4':
                        width = baseSize;
                        height = Math.round(baseSize * 4 / 5);
                        break;
                    case '4:5':
                        width = Math.round(baseSize * 4 / 5);
                        height = baseSize;
                        break;
                    default:
                        width = baseSize;
                        height = Math.round(baseSize * 9 / 16);
                }
                
                const displayWidth = Math.min(width, 400);
                const displayHeight = Math.round(displayWidth * height / width);
                
                const existingNodes = imageResponseContainer.querySelectorAll('.canvas-node');
                let x = 5000;
                let y = 5000;
                
                if (existingNodes.length > 0) {
                    const lastNode = existingNodes[existingNodes.length - 1];
                    
                    const lastNodeX = parseInt(lastNode.style.left) || 0;
                    const lastNodeY = parseInt(lastNode.style.top) || 0;
                    const lastNodeWidth = lastNode.offsetWidth;
                    const lastNodeHeight = lastNode.offsetHeight;
                    
                    x = lastNodeX + lastNodeWidth + 50;
                    y = lastNodeY;
                    
                    if (x > 6000) {
                        x = 5000;
                        y = lastNodeY + lastNodeHeight + 50;
                    }
                }
                
                // ÂàõÂª∫‰∏Ä‰∏™canvas-nodeÂÖÉÁ¥†‰Ωú‰∏∫Âç†‰ΩçÁ¨¶
                loadingPlaceholder = createLoadingPlaceholder(displayWidth, displayHeight, x, y);
                imageResponseContainer.appendChild(loadingPlaceholder);
                
                // Á´ãÂç≥Êõ¥Êñ∞Áº©Áï•ÂõæÔºåÊòæÁ§∫Âç†‰ΩçÁ¨¶
                updateMinimapWithImage(loadingPlaceholder);
            }

            try {
                let content;
                
                debugLog(`[APIËØ∑Ê±Ç] Ê®°Âºè: ${isImageGenMode ? 'ÁîüÂõæ' : 'ÊñáÊú¨'}, ÊèêÁ§∫ËØç: ${prompt}`, 'info');
                
                if (isImageGenMode) {
                    const allImageData = [...imageDataList];
                    
                    for (const info of pinInfo) {
                        const node = findNodeByImageUrl(info.imageUrl);
                        if (node) {
                            const img = node.querySelector('img');
                            const pins = JSON.parse(node.dataset.pins || '[]');
                            
                            let base64Data;
                            if (img.src.startsWith('data:')) {
                                base64Data = img.src;
                            } else {
                                const canvas = document.createElement('canvas');
                                const ctx = canvas.getContext('2d');
                                canvas.width = img.naturalWidth || img.width;
                                canvas.height = img.naturalHeight || img.height;
                                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                                base64Data = canvas.toDataURL('image/png');
                            }
                            
                            if (pins.length > 0) {
                                debugLog(`[PINÊ†áËÆ∞] Âú®ÂõæÁâá‰∏äÁªòÂà∂ ${pins.length} ‰∏™PINÊ†áËÆ∞`, 'info');
                                base64Data = await drawPinsOnImage(base64Data, pins);
                            }
                            
                            const existing = allImageData.find(data => data.data === base64Data);
                            if (!existing) {
                                allImageData.push({
                                    data: base64Data,
                                    name: info.filename
                                });
                            }
                        }
                    }
                    
                    if (allImageData.length > 0) {
                        if (prompt) {
                            content = allImageData.map(imageData => ({
                                inlineData: { 
                                    data: imageData.data.split(',')[1], 
                                    mimeType: imageData.data.split(';')[0].split(':')[1] 
                                }
                            }));
                            const pinNote = pinInfo.length > 0 ? 'ÂÆåÂÖ®ÁßªÈô§ÂõæÁâá‰∏äÁöÑÊâÄÊúâÁ∫¢Ëâ≤Êï∞Â≠óÊ†áËÆ∞Ôºå‰∏çË¶ÅÂú®ÁîüÊàêÁöÑÂõæÁâá‰∏≠ÊòæÁ§∫‰ªª‰ΩïÊ†áËÆ∞„ÄÇ' : '';
                            content.push(`${prompt}Ôºå‰ΩøÁî®${aspectRatio.value}ÂÆΩÈ´òÊØî„ÄÇ${pinNote}`);
                        } else {
                            content = allImageData.map(imageData => ({
                                inlineData: { 
                                    data: imageData.data.split(',')[1], 
                                    mimeType: imageData.data.split(';')[0].split(':')[1] 
                                }
                            }));
                            const pinNote = pinInfo.length > 0 ? 'ÂÆåÂÖ®ÁßªÈô§ÂõæÁâá‰∏äÁöÑÊâÄÊúâÁ∫¢Ëâ≤Êï∞Â≠óÊ†áËÆ∞Ôºå‰∏çË¶ÅÂú®ÁîüÊàêÁöÑÂõæÁâá‰∏≠ÊòæÁ§∫‰ªª‰ΩïÊ†áËÆ∞„ÄÇ' : '';
                            content.push(`ËØ∑ÁæéÂåñËøôÂº†ÂõæÁâáÔºå‰ΩøÁî®${aspectRatio.value}ÂÆΩÈ´òÊØî„ÄÇ${pinNote}`);
                        }
                    } else {
                        content = `${prompt}Ôºå‰ΩøÁî®${aspectRatio.value}ÂÆΩÈ´òÊØî`;
                    }
                } else {
                    const allImageData = [...imageDataList];
                    
                    for (const info of pinInfo) {
                        const node = findNodeByImageUrl(info.imageUrl);
                        if (node) {
                            const img = node.querySelector('img');
                            const pins = JSON.parse(node.dataset.pins || '[]');
                            
                            let base64Data;
                            if (img.src.startsWith('data:')) {
                                base64Data = img.src;
                            } else {
                                const canvas = document.createElement('canvas');
                                const ctx = canvas.getContext('2d');
                                canvas.width = img.naturalWidth || img.width;
                                canvas.height = img.naturalHeight || img.height;
                                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                                base64Data = canvas.toDataURL('image/png');
                            }
                            
                            if (pins.length > 0) {
                                debugLog(`[PINÊ†áËÆ∞] Âú®ÂõæÁâá‰∏äÁªòÂà∂ ${pins.length} ‰∏™PINÊ†áËÆ∞`, 'info');
                                base64Data = await drawPinsOnImage(base64Data, pins);
                            }
                            
                            const existing = allImageData.find(data => data.data === base64Data);
                            if (!existing) {
                                allImageData.push({
                                    data: base64Data,
                                    name: info.filename
                                });
                            }
                        }
                    }
                    
                    if (allImageData.length > 0) {
                        content = allImageData.map(imageData => ({
                            inlineData: {
                                data: imageData.data.split(',')[1],
                                mimeType: imageData.data.split(';')[0].split(':')[1]
                            }
                        }));
                        content.push(`${prompt}`);
                    } else {
                        content = prompt;
                    }
                    
                    const existingNodes = imageResponseContainer.querySelectorAll('.canvas-node');
                    let x = 5000;
                    let y = 5000;
                    
                    if (existingNodes.length > 0) {
                        const lastNode = existingNodes[existingNodes.length - 1];
                        
                        const lastNodeX = parseInt(lastNode.style.left) || 0;
                        const lastNodeY = parseInt(lastNode.style.top) || 0;
                        const lastNodeWidth = lastNode.offsetWidth;
                        const lastNodeHeight = lastNode.offsetHeight;
                        
                        x = lastNodeX + lastNodeWidth + 50;
                        y = lastNodeY;
                        
                        if (x > 6000) {
                            x = 5000;
                            y = lastNodeY + lastNodeHeight + 50;
                        }
                    }
                    
                    loadingPlaceholder = createTextLoadingPlaceholder(prompt, x, y);
                    imageResponseContainer.appendChild(loadingPlaceholder);
                    updateMinimapWithImage(loadingPlaceholder);
                }
                
                const result = await model.generateContent(content);
                const response = await result.response;
                
                debugLog(`[APIÂìçÂ∫î] Êî∂Âà∞ÂìçÂ∫î, ÂÄôÈÄâÊï∞Èáè: ${response.candidates?.length || 0}`, 'info');
                
                if (isImageGenMode) {
                    const imagePart = response.candidates[0]?.content?.parts.find(part => part.inlineData);
                    debugLog(`[ÁîüÂõæÊ®°Âºè] ÂõæÁâáÊï∞ÊçÆ: ${imagePart ? 'Â≠òÂú®' : '‰∏çÂ≠òÂú®'}`, 'info');
                    
                    if (imagePart) {
                        const imageData = imagePart.inlineData.data;
                        debugLog(`[ÂõæÁâáÊï∞ÊçÆ] Base64ÈïøÂ∫¶: ${imageData.length}`, 'info');
                        
                        const byteCharacters = atob(imageData);
                        const byteNumbers = new Array(byteCharacters.length);
                        for (let i = 0; i < byteCharacters.length; i++) {
                            byteNumbers[i] = byteCharacters.charCodeAt(i);
                        }
                        const byteArray = new Uint8Array(byteNumbers);
                        const blob = new Blob([byteArray], { type: 'image/png' });
                        const blobUrl = URL.createObjectURL(blob);
                        
                        let filename = '';
                        let resolution = '';
                        
                        try {
                            debugLog(`[‰øùÂ≠òÂõæÁâá] ÂºÄÂßã‰øùÂ≠òÂà∞ÊúçÂä°Âô®`, 'info');
                            const saveResponse = await fetch('/save-image', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ 
                                    imageData: imageData,
                                    prompt: prompt,
                                    aspectRatio: aspectRatio.value,
                                    imageSize: imageSize.value
                                })
                            });
                            const saveResult = await saveResponse.json();
                            debugLog(`[‰øùÂ≠òÂõæÁâá] ÊúçÂä°Âô®ÂìçÂ∫î: ${JSON.stringify(saveResult)}`, 'info');
                            if (saveResult.success) {
                                filename = saveResult.fileName || '';
                                debugLog(`[‰øùÂ≠òÂõæÁâá] Êñá‰ª∂Âêç: ${filename}`, 'success');
                                if (statusTag) {
                                    statusTag.innerText = "ÊàêÂäü";
                                }
                            } else {
                                debugLog(`[‰øùÂ≠òÂõæÁâá] ‰øùÂ≠òÂ§±Ë¥•: ${saveResult.message || 'Êú™Áü•ÈîôËØØ'}`, 'error');
                                if (statusTag) {
                                    statusTag.innerText = "‰øùÂ≠òÂ§±Ë¥•";
                                }
                            }
                        } catch (saveError) {
                            console.error('‰øùÂ≠òÂõæÁâáÂ§±Ë¥•:', saveError);
                            debugLog(`[‰øùÂ≠òÂõæÁâá] ÂºÇÂ∏∏: ${saveError.message}`, 'error');
                            if (statusTag) {
                                statusTag.innerText = "‰øùÂ≠òÂ§±Ë¥•";
                            }
                        }
                        
                        const tempImg = new Image();
                        tempImg.src = blobUrl;
                        await new Promise((resolve) => {
                            tempImg.onload = () => {
                                resolution = `${tempImg.naturalWidth}x${tempImg.naturalHeight}`;
                                resolve();
                            };
                        });
                        
                        if (loadingPlaceholder) {
                            // Êõ¥Êñ∞Áé∞ÊúâÁöÑloadingÂç†‰ΩçÁ¨¶ËäÇÁÇπ
                            updateLoadingPlaceholder(loadingPlaceholder, blobUrl, prompt, filename, resolution);
                        } else {
                            // Â¶ÇÊûúÊ≤°ÊúâÂç†‰ΩçÁ¨¶ÔºåÂàõÂª∫Êñ∞ËäÇÁÇπ
                            const node = createImageNode(blobUrl, prompt, nodeCounter++, filename, resolution);
                        imageResponseContainer.appendChild(node);
                        selectNode(node);
                        debugLog(`[ÂàõÂª∫ËäÇÁÇπ] ÂõæÁâáËäÇÁÇπ: ${filename}, ÂàÜËæ®Áéá: ${resolution}`, 'success');
                    }
                } else {
                    debugLog(`[ÁîüÂõæÊ®°Âºè] Êó†ÂõæÁâáÊï∞ÊçÆ`, 'warning');
                    if (statusTag) {
                        statusTag.innerText = "Êó†ÂõæÁâáÊï∞ÊçÆ";
                    }
                }
            } else {
                debugLog(`[ÊñáÊú¨Ê®°Âºè] ÂºÄÂßãÂ§ÑÁêÜÊñáÊú¨ÂìçÂ∫î`, 'info');
                const text = response.text();
                debugLog(`[ÊñáÊú¨ÂìçÂ∫î] ÊñáÊú¨ÈïøÂ∫¶: ${text.length}`, 'info');
                if (loadingPlaceholder) {
                    updateTextLoadingPlaceholder(loadingPlaceholder, text, prompt);
                    debugLog(`[Êõ¥Êñ∞ËäÇÁÇπ] ÊñáÊú¨Âç†‰ΩçÁ¨¶Â∑≤Êõ¥Êñ∞`, 'success');
                } else {
                    const node = createTextNode(text, prompt, nodeCounter++);
                    imageResponseContainer.appendChild(node);
                    selectNode(node);
                    updateMinimapWithImage(node);
                    debugLog(`[ÂàõÂª∫ËäÇÁÇπ] ÊñáÊú¨ËäÇÁÇπÂ∑≤ÂàõÂª∫`, 'success');
                }
            }
                
                debugLog(`[APIÂìçÂ∫î] Ê®°Âºè: ${isImageGenMode ? 'ÁîüÂõæ' : 'ÊñáÊú¨'}, Áä∂ÊÄÅ: ÊàêÂäü`, 'success');
                
                if (activeRequests === 0 && statusTag) {
                    statusTag.innerText = "ÊàêÂäü";
                    statusTag.className = "text-xs px-2 py-1 rounded bg-green-50 text-green-600";
                }
            } catch (error) {
                console.error(error);
                debugLog(`[APIÈîôËØØ] Ê®°Âºè: ${isImageGenMode ? 'ÁîüÂõæ' : 'ÊñáÊú¨'}, ÈîôËØØ: ${error.message}`, 'error');
                const errorText = "ÂèëÁîüÈîôËØØ: " + error.message;
                if (loadingPlaceholder) {
                    if (loadingPlaceholder.classList.contains('text-loading-placeholder')) {
                        updateTextLoadingPlaceholder(loadingPlaceholder, errorText, prompt);
                        loadingPlaceholder.querySelector('.text-prompt').style.background = '#fef2f2';
                        loadingPlaceholder.querySelector('.text-prompt').style.color = '#dc2626';
                    } else {
                        const node = createTextNode(errorText, prompt, nodeCounter++);
                        node.querySelector('.text-prompt').style.background = '#fef2f2';
                        node.querySelector('.text-prompt').style.color = '#dc2626';
                        imageResponseContainer.appendChild(node);
                        selectNode(node);
                        updateMinimapWithImage(node);
                        loadingPlaceholder.remove();
                    }
                } else {
                    const node = createTextNode(errorText, prompt, nodeCounter++);
                    node.querySelector('.text-prompt').style.background = '#fef2f2';
                    node.querySelector('.text-prompt').style.color = '#dc2626';
                    imageResponseContainer.appendChild(node);
                    selectNode(node);
                    updateMinimapWithImage(node);
                }
                if (activeRequests === 0 && statusTag) {
                    statusTag.innerText = "Â§±Ë¥•";
                    statusTag.className = "text-xs px-2 py-1 rounded bg-red-50 text-red-600";
                }
            } finally {
                activeRequests--;
                if (activeRequests === 0) {
                    loader.classList.add('hidden');
                }
                // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
                promptInput.innerHTML = '';
            }
        }

        sendBtn.addEventListener('click', callAPI);

        promptInput.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') callAPI();
        });

        document.addEventListener('wheel', (e) => {
            if (!e.ctrlKey) return;
            
            if (document.activeElement === promptInput) return;
            
            e.preventDefault();
            
            const currentScale = panzoom.getScale();
            const delta = e.deltaY > 0 ? -0.25 : 0.25;
            const newScale = Math.max(0.5, Math.min(2.5, currentScale + delta));
            updateCanvasScale(newScale);
        }, { passive: false });

        document.addEventListener('keydown', (e) => {
            // Ctrl + ` ÂàáÊç¢Ë∞ÉËØïÊéßÂà∂Èù¢Êùø
            if (e.ctrlKey && e.key === '`') {
                e.preventDefault();
                debugConsole.classList.toggle('collapsed');
                return;
            }
            
            if (document.activeElement === promptInput) return;
            
            // ÁîªÂ∏ÉÁº©ÊîæÂø´Êç∑ÈîÆÔºàCtrl +/-Ôºâ
            if (e.ctrlKey && !e.shiftKey && (e.key === '=' || e.key === '+')) {
                e.preventDefault();
                const currentScale = panzoom.getScale();
                const newScale = Math.min(2.5, currentScale + 0.25);
                updateCanvasScale(newScale);
                return;
            }
            
            if (e.ctrlKey && !e.shiftKey && (e.key === '-' || e.key === '_')) {
                e.preventDefault();
                const currentScale = panzoom.getScale();
                const newScale = Math.max(0.5, currentScale - 0.25);
                updateCanvasScale(newScale);
                return;
            }
            
            if (selectedNode) {
                if (e.ctrlKey || e.metaKey) {
                    if (e.key === 'c' || e.key === 'C') {
                        e.preventDefault();
                        copySelectedNode();
                        return;
                    }
                    if (e.key === 'x' || e.key === 'X') {
                        e.preventDefault();
                        cutSelectedNode();
                        return;
                    }
                }
                
                if (e.key === 'Delete' || e.key === 'Backspace') {
                    e.preventDefault();
                    deleteSelectedNode();
                    return;
                }
                
                // Â§ÑÁêÜÊñπÂêëÈîÆÁßªÂä®
                const step = 10;
                const currentLeft = parseInt(selectedNode.style.left) || 0;
                const currentTop = parseInt(selectedNode.style.top) || 0;
                
                switch (e.key) {
                    case 'ArrowUp':
                        e.preventDefault();
                        selectedNode.style.top = `${currentTop - step}px`;
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        selectedNode.style.top = `${currentTop + step}px`;
                        break;
                    case 'ArrowLeft':
                        e.preventDefault();
                        selectedNode.style.left = `${currentLeft - step}px`;
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        selectedNode.style.left = `${currentLeft + step}px`;
                        break;
                }
            }
        });

        window.addEventListener('load', () => {
            setTimeout(initCanvas, 100);
        });
        
        // Âä®ÊÄÅÁõëÂê¨resize‰∫ã‰ª∂ÔºåÂΩìÁ™óÂè£Â§ßÂ∞èÊîπÂèòÊó∂Ëá™Âä®Âà∑Êñ∞UI
        window.addEventListener('resize', () => {
            refreshUI();
        });
    </script>
</body>
</html>