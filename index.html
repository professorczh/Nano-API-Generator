<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒ Nano Generator</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23FFD700' d='M12 2C8.5 2 5.5 4.5 4.5 8c-.5 2 .5 4 2 5.5 0 1.5-1 2.5-1.5 4 0 2.5 2 4.5 4.5 4.5 1.5 0 2.5-.5 3.5-1.5.5 1.5.5 3.5 1.5 5.5 0 2-1 3.5-2.5 4-1.5.5-3.5 0-5-1.5-2-3.5-2-5 0-2 1-3.5 2.5-4.5-.5-1.5-.5-3.5-.5-5.5 0-1.5.5-2.5 1.5-3.5-.5-1-1.5-1.5-3-1.5-2 0-3.5 1-4.5 3z'/%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@panzoom/panzoom@4.5.1/dist/panzoom.min.js"></script>
    <style>
        .glass-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(230, 230, 230, 1);
        }
        .image-card {
            position: relative;
            height: 120px;
            overflow: hidden;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .image-card img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            cursor: pointer;
        }
        .image-card .delete-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 24px;
            height: 24px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 16px;
            line-height: 1;
            z-index: 10;
        }
        .image-card:hover .delete-btn {
            opacity: 1;
        }
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #2563eb;
            border-radius: 50%;
            cursor: pointer;
        }
        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #2563eb;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }
        .image-response-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .viewport {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background: #fafafa;
        }
        .canvas {
            position: absolute;
            transform-origin: center center;
            transition: transform 0.075s ease-out;
        }
        .canvas.dragging {
            cursor: grab;
        }
        .canvas.dragging:active {
            cursor: grabbing;
        }
        .node {
            position: relative;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .node:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }
        .node.selected {
            box-shadow: 0 0 0 3px #3b82f6, 0 4px 16px rgba(59, 130, 246, 0.3);
        }
        .node-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 12px 12px 0 0;
        }
        .node-content {
            padding: 12px;
        }
        .node-prompt {
            font-size: 12px;
            color: #6b7280;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .node-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            font-size: 11px;
            color: #9ca3af;
        }
        .node-delete {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 28px;
            height: 28px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 18px;
            line-height: 1;
            z-index: 10;
        }
        .node:hover .node-delete {
            opacity: 1;
        }
        .selection-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            cursor: crosshair;
            z-index: 20;
        }
        .selection-box {
            position: absolute;
            border: 2px dashed #3b82f6;
            background: rgba(59, 130, 246, 0.1);
            pointer-events: none;
        }
        .selection-prompt {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 30;
            pointer-events: none;
        }
        .snap-line {
            position: absolute;
            background: #3b82f6;
            pointer-events: none;
            z-index: 100;
        }
        .snap-line.horizontal {
            height: 1px;
            left: 0;
            right: 0;
        }
        .snap-line.vertical {
            width: 1px;
            top: 0;
            bottom: 0;
        }
        .floating-toolbar {
            position: absolute;
            top: 50%;
            right: -60px;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            padding: 4px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
            z-index: 50;
        }
        .node.selected .floating-toolbar {
            opacity: 1;
            pointer-events: auto;
        }
        .toolbar-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #6b7280;
        }
        .toolbar-btn:hover {
            background: #f3f4f6;
            color: #3b82f6;
        }
        .toolbar-btn svg {
            width: 18px;
            height: 18px;
        }
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 40;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        .node.loading .loading-overlay {
            opacity: 1;
            pointer-events: auto;
        }
        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid #e5e7eb;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        .loading-ripple {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid #3b82f6;
            opacity: 0;
            animation: ripple 1.5s ease-out infinite;
        }
        @keyframes ripple {
            0% {
                transform: scale(0.8);
                opacity: 0.8;
            }
            100% {
                transform: scale(1.2);
                opacity: 0;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen text-gray-800">

    <div id="viewport" class="viewport">
        <div id="canvas" class="canvas">
            <div class="max-w-4xl mx-auto py-12 px-4">
                <header class="mb-10 text-center">
                    <h1 class="text-3xl font-bold text-gray-900">Nano Generator</h1>
                </header>

                <main class="space-y-6">
            <div class="glass-card rounded-2xl p-6 shadow-sm">
                <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <label class="block text-sm font-medium text-gray-700">API Key</label>
                            <a href="https://aistudio.google.com/api-keys" target="_blank" class="text-xs text-blue-600 hover:text-blue-700 underline">è·å– API Key</a>
                        </div>
                        <button id="toggleApiKeyPanel" class="text-sm text-blue-600 hover:text-blue-700">æŠ˜å </button>
                    </div>
                <div id="apiKeyPanel">
                    <div class="flex gap-3">
                        <input type="text" id="apiKeyInput" 
                            class="flex-1 p-4 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all"
                            placeholder="è¾“å…¥ä½ çš„ API Key">
                        <button id="testApiKeyBtn" 
                            class="bg-gray-600 hover:bg-gray-700 text-white px-5 py-2.5 rounded-lg font-medium transition-colors shadow-sm flex items-center gap-2 whitespace-nowrap">
                            <span>æµ‹è¯•</span>
                            <div id="testLoader" class="hidden animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full"></div>
                        </button>
                    </div>
                    <div id="apiStatus" class="mt-2 text-sm text-gray-500"></div>
                    
                    <div class="mt-3 flex gap-3">
                        <button id="saveApiKeyBtn" 
                            class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors shadow-sm text-sm">
                            å­˜å‚¨ API
                        </button>
                        <button id="clearApiKeyBtn" 
                            class="flex-1 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition-colors shadow-sm text-sm">
                            æ¸…é™¤ API
                        </button>
                    </div>
                    
                    <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">æ–‡æœ¬æ¨¡å‹</label>
                            <select id="textModelName" 
                                class="w-full px-3 py-2 rounded-lg border border-gray-200 bg-white text-gray-700 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all">
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">è¯†å›¾æ¨¡å‹</label>
                            <select id="visionModelName" 
                                class="w-full px-3 py-2 rounded-lg border border-gray-200 bg-white text-gray-700 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all">
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">ç”Ÿå›¾æ¨¡å‹</label>
                            <select id="imageModelName" 
                                class="w-full px-3 py-2 rounded-lg border border-gray-200 bg-white text-gray-700 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all">
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="glass-card rounded-2xl p-6 shadow-sm">
                <div class="flex items-center justify-between mb-2">
                    <label class="block text-sm font-medium text-gray-700">æç¤ºè¯</label>
                    <button id="togglePromptPanel" class="text-sm text-blue-600 hover:text-blue-700">æŠ˜å </button>
                </div>
                <div id="promptPanel">
                    <textarea id="promptInput" rows="4" 
                        class="w-full p-4 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all resize-none"
                        placeholder="è¯·è¾“å…¥æç¤ºè¯"></textarea>
                    
                    <div id="imagePreviewContainer" class="mt-4 hidden">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-gray-700">å·²ç²˜è´´å›¾ç‰‡</span>
                            <button id="clearAllImagesBtn" class="text-sm text-red-600 hover:text-red-700">æ¸…ç©ºå…¨éƒ¨</button>
                        </div>
                        <div id="imageGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3"></div>
                    </div>
                    
                    <div class="mt-4 flex justify-between items-center">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="imageGenMode" class="w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span class="text-gray-700 font-medium">ç”Ÿå›¾æ¨¡å¼</span>
                        </label>
                        <button id="sendBtn" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-lg font-medium transition-colors shadow-sm flex items-center gap-2">
                            <span>å‘é€</span>
                            <div id="loader" class="hidden animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full"></div>
                        </button>
                    </div>

                    <div id="imageGenOptions" class="mt-4 hidden">
                        <div class="border-t border-gray-200 pt-4">
                            <h3 class="text-sm font-semibold text-gray-700 mb-3">ç”Ÿå›¾å‚æ•°è®¾ç½®</h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">å®½é«˜æ¯”</label>
                                    <select id="aspectRatio" 
                                        class="w-full px-3 py-2 rounded-lg border border-gray-200 bg-white text-gray-700 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all">
                                        <option value="1:1">1:1 æ­£æ–¹å½¢</option>
                                        <option value="16:9" selected>16:9 å®½å±</option>
                                        <option value="9:16">9:16 ç«–å±</option>
                                        <option value="21:9">21:9 è¶…å®½å±</option>
                                        <option value="4:3">4:3 ä¼ ç»Ÿæ¨ªå‘</option>
                                        <option value="3:4">3:4 ä¼ ç»Ÿç«–å‘</option>
                                        <option value="3:2">3:2 ç»å…¸æ¨ªå‘</option>
                                        <option value="2:3">2:3 ç»å…¸ç«–å‘</option>
                                        <option value="5:4">5:4 å¤§ç”»å¹…æ¨ªå‘</option>
                                        <option value="4:5">4:5 å¤§ç”»å¹…ç«–å‘</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">åˆ†è¾¨ç‡</label>
                                    <select id="imageSize" 
                                        class="w-full px-3 py-2 rounded-lg border border-gray-200 bg-white text-gray-700 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all">
                                        <option value="1K" selected>1K (1024px)</option>
                                        <option value="2K">2K é«˜æ¸…</option>
                                        <option value="4K">4K è¶…é«˜æ¸…</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        æ¸©åº¦: <span id="temperatureValue">0.6</span>
                                    </label>
                                    <input type="range" id="temperature" min="0" max="1" step="0.1" value="0.6" 
                                        class="w-full">
                                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                                        <span>ç¡®å®šæ€§</span>
                                        <span>åˆ›é€ æ€§</span>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Top-P: <span id="topPValue">0.95</span>
                                    </label>
                                    <input type="range" id="topP" min="0" max="1" step="0.05" value="0.95" 
                                        class="w-full">
                                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                                        <span>é›†ä¸­</span>
                                        <span>å¤šæ ·</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="glass-card rounded-2xl p-6 shadow-sm min-h-[200px]">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-sm font-semibold text-gray-400 uppercase tracking-wider">è¿”å›ç»“æœ (Response)</h2>
                    <span id="statusTag" class="text-xs px-2 py-1 rounded bg-gray-100 text-gray-500">ç­‰å¾…ä¸­</span>
                </div>
                <div id="responseOutput" class="whitespace-pre-wrap text-gray-700 leading-relaxed italic text-gray-400">
                    å†…å®¹å°†åœ¨æ­¤å¤„æ˜¾ç¤º...
                </div>
                <div id="imageResponseContainer" class="hidden mt-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-gray-700">è¿”å›çš„å›¾ç‰‡</span>
                    </div>
                    <div class="image-response-wrapper">
                        <img id="imageResponse" class="max-w-full max-h-96 rounded-lg border border-gray-200 cursor-pointer" alt="è¿”å›çš„å›¾ç‰‡">
                    </div>
                </div>
            </div>
            </main>
        </div>
    </div>
    </div>

    <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-90 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl p-6 max-w-[95vw] max-h-[95vh] w-full shadow-2xl flex flex-col">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h3 class="text-lg font-semibold text-gray-900">å›¾ç‰‡é¢„è§ˆ</h3>
                <button id="closeModalBtn" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <div class="flex justify-center mb-6 flex-grow overflow-auto">
                <img id="modalImage" class="max-w-full max-h-[75vh] rounded-lg object-contain" alt="é¢„è§ˆå›¾ç‰‡">
            </div>
            <div class="flex justify-end gap-3 flex-shrink-0">
                <button id="openFolderBtn" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors">æ‰“å¼€æ–‡ä»¶å¤¹</button>
                <button id="closeModalBtn2" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors">å…³é—­</button>
                <button id="downloadModalBtn" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition-colors">ä¸‹è½½</button>
            </div>
        </div>
    </div>

    <script type="importmap">
    {
      "imports": {
        "@google/generative-ai": "https://esm.run/@google/generative-ai"
      }
    }
    </script>
    
    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";
        import { CONFIG, TEXT_MODELS, IMAGE_MODELS } from "./config.js";

        const sendBtn = document.getElementById('sendBtn');
        const promptInput = document.getElementById('promptInput');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const responseOutput = document.getElementById('responseOutput');
        const loader = document.getElementById('loader');
        const statusTag = document.getElementById('statusTag');
        const testApiKeyBtn = document.getElementById('testApiKeyBtn');
        const testLoader = document.getElementById('testLoader');
        const apiStatus = document.getElementById('apiStatus');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        const imageGrid = document.getElementById('imageGrid');
        const clearAllImagesBtn = document.getElementById('clearAllImagesBtn');
        const imageGenMode = document.getElementById('imageGenMode');
        const imageGenOptions = document.getElementById('imageGenOptions');
        const aspectRatio = document.getElementById('aspectRatio');
        const imageSize = document.getElementById('imageSize');
        const temperature = document.getElementById('temperature');
        const topP = document.getElementById('topP');
        const temperatureValue = document.getElementById('temperatureValue');
        const topPValue = document.getElementById('topPValue');
        const imageResponseContainer = document.getElementById('imageResponseContainer');
        const imageResponse = document.getElementById('imageResponse');
        const textModelName = document.getElementById('textModelName');
        const visionModelName = document.getElementById('visionModelName');
        const imageModelName = document.getElementById('imageModelName');
        const imageModal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const closeModalBtn2 = document.getElementById('closeModalBtn2');
        const downloadModalBtn = document.getElementById('downloadModalBtn');
        const openFolderBtn = document.getElementById('openFolderBtn');
        const toggleApiKeyPanel = document.getElementById('toggleApiKeyPanel');
        const togglePromptPanel = document.getElementById('togglePromptPanel');
        const apiKeyPanel = document.getElementById('apiKeyPanel');
        const promptPanel = document.getElementById('promptPanel');
        let currentBlobUrl = null;

        const viewport = document.getElementById('viewport');
        const canvas = document.getElementById('canvas');

        const panzoom = Panzoom(canvas, {
            minScale: 0.5,
            maxScale: 3,
            step: 0.1,
            contain: 'outside',
            cursor: 'default',
            disableZoom: false,
            disablePan: false,
            smooth: true
        });

        viewport.addEventListener('wheel', (e) => {
            if (!e.ctrlKey) {
                e.preventDefault();
                panzoom.zoomWithWheel(e);
            }
        }, { passive: false });

        function maskApiKey(apiKey) {
            if (!apiKey || apiKey.length < 6) return apiKey;
            return apiKey.substring(0, 3) + '*'.repeat(apiKey.length - 6) + apiKey.substring(apiKey.length - 3);
        }

        function updateApiKeyDisplay() {
            const apiKey = apiKeyInput.value;
            if (apiKey) {
                apiKeyInput.value = maskApiKey(apiKey);
            }
        }

        apiKeyInput.value = CONFIG.API_KEY;
        updateApiKeyDisplay();

        apiKeyInput.addEventListener('focus', () => {
            apiKeyInput.value = CONFIG.API_KEY;
        });

        apiKeyInput.addEventListener('blur', () => {
            const newValue = apiKeyInput.value.trim();
            if (newValue && newValue !== maskApiKey(CONFIG.API_KEY)) {
                CONFIG.API_KEY = newValue;
            }
            updateApiKeyDisplay();
        });

        apiKeyInput.addEventListener('input', () => {
            const newValue = apiKeyInput.value.trim();
            if (newValue && !newValue.includes('*')) {
                CONFIG.API_KEY = newValue;
            }
        });

        toggleApiKeyPanel.addEventListener('click', () => {
            if (apiKeyPanel.classList.contains('hidden')) {
                apiKeyPanel.classList.remove('hidden');
                toggleApiKeyPanel.textContent = 'æŠ˜å ';
            } else {
                apiKeyPanel.classList.add('hidden');
                toggleApiKeyPanel.textContent = 'å±•å¼€';
            }
        });

        togglePromptPanel.addEventListener('click', () => {
            if (promptPanel.classList.contains('hidden')) {
                promptPanel.classList.remove('hidden');
                togglePromptPanel.textContent = 'æŠ˜å ';
            } else {
                promptPanel.classList.add('hidden');
                togglePromptPanel.textContent = 'å±•å¼€';
            }
        });

        function openModal(blobUrl) {
            currentBlobUrl = blobUrl;
            modalImage.src = blobUrl;
            imageModal.classList.remove('hidden');
            imageModal.classList.add('flex');
        }

        function closeModal() {
            imageModal.classList.add('hidden');
            imageModal.classList.remove('flex');
        }

        closeModalBtn.addEventListener('click', closeModal);
        closeModalBtn2.addEventListener('click', closeModal);
        imageModal.addEventListener('click', (e) => {
            if (e.target === imageModal) {
                closeModal();
            }
        });

        downloadModalBtn.addEventListener('click', () => {
            if (currentBlobUrl) {
                const link = document.createElement('a');
                link.href = currentBlobUrl;
                link.download = `gemini-generated-${Date.now()}.png`;
                link.click();
            }
        });

        openFolderBtn.addEventListener('click', async () => {
            try {
                const response = await fetch('/open-folder', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });
                const result = await response.json();
                if (result.success) {
                    alert(`${result.message}\n\nè¯·å¤åˆ¶è·¯å¾„å¹¶åœ¨æ–‡ä»¶èµ„æºç®¡ç†å™¨ä¸­æ‰“å¼€`);
                    navigator.clipboard.writeText(result.path).then(() => {
                        console.log('è·¯å¾„å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                    }).catch(err => {
                        console.error('å¤åˆ¶å¤±è´¥:', err);
                    });
                } else {
                    alert('æ‰“å¼€æ–‡ä»¶å¤¹å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                alert('æ‰“å¼€æ–‡ä»¶å¤¹å¤±è´¥: ' + error.message);
            }
        });

        apiKeyInput.value = CONFIG.API_KEY;

        function populateModelSelects() {
            TEXT_MODELS.forEach(model => {
                const option = document.createElement('option');
                option.value = model.value;
                option.textContent = model.name;
                if (model.value === CONFIG.MODEL_NAME) {
                    option.selected = true;
                }
                textModelName.appendChild(option);
                
                const visionOption = document.createElement('option');
                visionOption.value = model.value;
                visionOption.textContent = model.name;
                if (model.value === CONFIG.MODEL_NAME) {
                    visionOption.selected = true;
                }
                visionModelName.appendChild(visionOption);
            });

            IMAGE_MODELS.forEach(model => {
                const option = document.createElement('option');
                option.value = model.value;
                option.textContent = model.name;
                if (model.value === CONFIG.IMAGE_MODEL_NAME) {
                    option.selected = true;
                }
                imageModelName.appendChild(option);
            });
        }

        populateModelSelects();

        let imageDataList = [];
        let selectedNodeIndex = -1;

        function getImageAspectRatio(imageData) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const aspectRatio = img.width / img.height;
                    resolve(aspectRatio);
                };
                img.onerror = () => {
                    resolve(1);
                };
                img.src = imageData;
            });
        }

        function renderImageCards() {
            imageGrid.innerHTML = '';
            
            if (imageDataList.length === 0) {
                imagePreviewContainer.classList.add('hidden');
                return;
            }
            
            imagePreviewContainer.classList.remove('hidden');
            
            imageDataList.forEach((imageData, index) => {
                const node = document.createElement('div');
                node.className = `node ${selectedNodeIndex === index ? 'selected' : ''}`;
                node.dataset.index = index;
                
                const img = document.createElement('img');
                img.src = imageData;
                img.className = 'node-image';
                img.alt = `å›¾ç‰‡ ${index + 1}`;
                
                const selectionOverlay = document.createElement('div');
                selectionOverlay.className = 'selection-overlay';
                selectionOverlay.dataset.index = index;
                
                const deleteBtn = document.createElement('div');
                deleteBtn.className = 'node-delete';
                deleteBtn.textContent = 'Ã—';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    imageDataList.splice(index, 1);
                    if (selectedNodeIndex === index) {
                        selectedNodeIndex = -1;
                    } else if (selectedNodeIndex > index) {
                        selectedNodeIndex--;
                    }
                    renderImageCards();
                };
                
                const content = document.createElement('div');
                content.className = 'node-content';
                
                const prompt = document.createElement('div');
                prompt.className = 'node-prompt';
                prompt.textContent = 'å›¾ç‰‡ ' + (index + 1);
                
                const meta = document.createElement('div');
                meta.className = 'node-meta';
                meta.innerHTML = `<span>ç‚¹å‡»æŸ¥çœ‹</span><span>${imageDataList.length} å¼ </span>`;
                
                content.appendChild(prompt);
                content.appendChild(meta);
                
                node.appendChild(img);
                node.appendChild(selectionOverlay);
                node.appendChild(deleteBtn);
                node.appendChild(content);
                
                const toolbar = document.createElement('div');
                toolbar.className = 'floating-toolbar';
                
                const editBtn = document.createElement('button');
                editBtn.className = 'toolbar-btn';
                editBtn.title = 'ç¼–è¾‘';
                editBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 4H4a2 2 0 0 0 0-2 2v14a2 2 0 0 0 0 2 2h14a2 2 0 0 0 0 2-2v-7"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-1-4 9.5-9.5z"/>
                </svg>`;
                editBtn.onclick = (e) => {
                    e.stopPropagation();
                    console.log('ç¼–è¾‘å›¾ç‰‡', index);
                };
                
                const downloadBtn = document.createElement('button');
                downloadBtn.className = 'toolbar-btn';
                downloadBtn.title = 'ä¸‹è½½';
                downloadBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                </svg>`;
                downloadBtn.onclick = (e) => {
                    e.stopPropagation();
                    const link = document.createElement('a');
                    link.href = imageData;
                    link.download = `nano-generated-${index + 1}.png`;
                    link.click();
                };
                
                const shareBtn = document.createElement('button');
                shareBtn.className = 'toolbar-btn';
                shareBtn.title = 'åˆ†äº«';
                shareBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 1 1 0 0-5.368 0 3 3 0 0 0 5.368 0m5.368 0a3 3 0 1 0 0-5.368 0 3 3 0 0 0 5.368 0M9 12a3 3 0 1 0 0 6 0m0 0a3 3 0 1 0 0 6 0m-9 0H9m9 0h-9"/>
                </svg>`;
                shareBtn.onclick = (e) => {
                    e.stopPropagation();
                    if (navigator.share) {
                        navigator.share({
                            title: 'Nano ç”Ÿæˆçš„å›¾ç‰‡',
                            text: 'æŸ¥çœ‹æˆ‘ä½¿ç”¨ Nano ç”Ÿæˆçš„å›¾ç‰‡',
                            url: imageData
                        }).catch(console.error);
                    } else {
                        alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåˆ†äº«åŠŸèƒ½');
                    }
                };
                
                toolbar.appendChild(editBtn);
                toolbar.appendChild(downloadBtn);
                toolbar.appendChild(shareBtn);
                node.appendChild(toolbar);
                
                const loadingOverlay = document.createElement('div');
                loadingOverlay.className = 'loading-overlay';
                
                const spinner = document.createElement('div');
                spinner.className = 'loading-spinner';
                
                loadingOverlay.appendChild(spinner);
                node.appendChild(loadingOverlay);
                
                let isSelecting = false;
                let startX, startY, selectionBox;
                
                selectionOverlay.addEventListener('mousedown', (e) => {
                    e.stopPropagation();
                    isSelecting = true;
                    const rect = selectionOverlay.getBoundingClientRect();
                    startX = e.clientX - rect.left;
                    startY = e.clientY - rect.top;
                    
                    selectionBox = document.createElement('div');
                    selectionBox.className = 'selection-box';
                    selectionBox.style.left = startX + 'px';
                    selectionBox.style.top = startY + 'px';
                    selectionBox.style.width = '0px';
                    selectionBox.style.height = '0px';
                    selectionOverlay.appendChild(selectionBox);
                });
                
                selectionOverlay.addEventListener('mousemove', (e) => {
                    if (!isSelecting) return;
                    const rect = selectionOverlay.getBoundingClientRect();
                    const currentX = e.clientX - rect.left;
                    const currentY = e.clientY - rect.top;
                    
                    const width = currentX - startX;
                    const height = currentY - startY;
                    
                    selectionBox.style.left = (width < 0 ? currentX : startX) + 'px';
                    selectionBox.style.top = (height < 0 ? currentY : startY) + 'px';
                    selectionBox.style.width = Math.abs(width) + 'px';
                    selectionBox.style.height = Math.abs(height) + 'px';
                });
                
                selectionOverlay.addEventListener('mouseup', (e) => {
                    if (!isSelecting) return;
                    isSelecting = false;
                    
                    const rect = selectionOverlay.getBoundingClientRect();
                    const currentX = e.clientX - rect.left;
                    const currentY = e.clientY - rect.top;
                    
                    const width = Math.abs(currentX - startX);
                    const height = Math.abs(currentY - startY);
                    
                    if (width > 20 && height > 20) {
                        const prompt = prompt('è¯·è¾“å…¥è¦ä¿®æ”¹çš„å†…å®¹ï¼š');
                        if (prompt) {
                            console.log('å±€éƒ¨é‡ç»˜ï¼š', { index, startX, startY, width, height, prompt });
                        }
                    }
                    
                    if (selectionBox) {
                        selectionBox.remove();
                        selectionBox = null;
                    }
                });
                
                selectionOverlay.addEventListener('mouseleave', () => {
                    if (isSelecting && selectionBox) {
                        selectionBox.remove();
                        selectionBox = null;
                        isSelecting = false;
                    }
                });
                
                node.onclick = () => {
                    selectedNodeIndex = index;
                    renderImageCards();
                    window.open(imageData, '_blank');
                };
                
                imageGrid.appendChild(node);
            });
        }

        promptInput.addEventListener('paste', async (e) => {
            const items = e.clipboardData.items;
            let hasImage = false;
            
            for (let item of items) {
                if (item.type.indexOf('image') !== -1) {
                    e.preventDefault();
                    hasImage = true;
                    
                    const file = item.getAsFile();
                    const reader = new FileReader();
                    
                    reader.onload = (event) => {
                        const base64Data = event.target.result;
                        imageDataList.push(base64Data);
                        renderImageCards();
                    };
                    
                    reader.readAsDataURL(file);
                }
            }
        });

        clearAllImagesBtn.addEventListener('click', () => {
            imageDataList = [];
            renderImageCards();
        });

        imageGenMode.addEventListener('change', () => {
            if (imageGenMode.checked) {
                imageGenOptions.classList.remove('hidden');
            } else {
                imageGenOptions.classList.add('hidden');
            }
        });

        temperature.addEventListener('input', () => {
            temperatureValue.textContent = temperature.value;
        });

        topP.addEventListener('input', () => {
            topPValue.textContent = topP.value;
        });

        async function testApiKey() {
            const apiKey = CONFIG.API_KEY.trim();
            
            if (!apiKey || apiKey === "YOUR_API_KEY_HERE") {
                apiStatus.innerHTML = '<span class="text-red-600">è¯·è¾“å…¥æœ‰æ•ˆçš„ API Key</span>';
                return;
            }

            testApiKeyBtn.disabled = true;
            testLoader.classList.remove('hidden');
            apiStatus.innerHTML = '<span class="text-blue-600">æ­£åœ¨éªŒè¯ API Key...</span>';

            try {
                const genAI = new GoogleGenerativeAI(apiKey);
                const model = genAI.getGenerativeModel({ model: CONFIG.MODEL_NAME });
                
                const result = await model.generateContent("test");
                await result.response;
                
                apiStatus.innerHTML = '<span class="text-green-600">âœ“ API Key éªŒè¯æˆåŠŸ</span>';
            } catch (error) {
                console.error(error);
                apiStatus.innerHTML = '<span class="text-red-600">âœ— API Key æ— æ•ˆ: ' + error.message + '</span>';
            } finally {
                testApiKeyBtn.disabled = false;
                testLoader.classList.add('hidden');
            }
        }

        async function saveApiKey() {
            const apiKey = CONFIG.API_KEY.trim();
            
            if (!apiKey || apiKey === "YOUR_API_KEY_HERE") {
                apiStatus.innerHTML = '<span class="text-red-600">è¯·è¾“å…¥æœ‰æ•ˆçš„ API Key</span>';
                return;
            }

            try {
                const saveEnvResponse = await fetch('/save-env', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        apiKey: apiKey,
                        modelName: textModelName.value,
                        imageModelName: imageModelName.value
                    })
                });
                
                const saveEnvResult = await saveEnvResponse.json();
                
                if (saveEnvResult.success) {
                    const reloadEnvResponse = await fetch('/reload-env', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const reloadEnvResult = await reloadEnvResponse.json();
                    
                    if (reloadEnvResult.success) {
                        CONFIG.API_KEY = apiKey;
                        CONFIG.MODEL_NAME = textModelName.value;
                        CONFIG.IMAGE_MODEL_NAME = imageModelName.value;
                        apiStatus.innerHTML = '<span class="text-green-600">âœ“ API Key å·²ä¿å­˜åˆ°æœåŠ¡å™¨</span>';
                    } else {
                        apiStatus.innerHTML = '<span class="text-yellow-600">âœ“ API Key å·²ä¿å­˜ï¼Œä½†ç¯å¢ƒå˜é‡é‡è½½å¤±è´¥: ' + reloadEnvResult.error + '</span>';
                    }
                } else {
                    apiStatus.innerHTML = '<span class="text-red-600">âœ— ä¿å­˜å¤±è´¥: ' + saveEnvResult.error + '</span>';
                }
            } catch (error) {
                console.error(error);
                apiStatus.innerHTML = '<span class="text-red-600">âœ— ä¿å­˜å¤±è´¥: ' + error.message + '</span>';
            }
        }

        async function clearApiKey() {
            try {
                const clearEnvResponse = await fetch('/clear-env', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const clearEnvResult = await clearEnvResponse.json();
                
                if (clearEnvResult.success) {
                    CONFIG.API_KEY = '';
                    CONFIG.MODEL_NAME = 'gemini-3-flash-preview';
                    CONFIG.IMAGE_MODEL_NAME = 'gemini-3-pro-image-preview';
                    apiKeyInput.value = '';
                    apiStatus.innerHTML = '<span class="text-green-600">âœ“ API Key å·²ä»æœåŠ¡å™¨æ¸…é™¤</span>';
                } else {
                    apiStatus.innerHTML = '<span class="text-red-600">âœ— æ¸…é™¤å¤±è´¥: ' + clearEnvResult.error + '</span>';
                }
            } catch (error) {
                console.error(error);
                apiStatus.innerHTML = '<span class="text-red-600">âœ— æ¸…é™¤å¤±è´¥: ' + error.message + '</span>';
            }
        }

        testApiKeyBtn.addEventListener('click', testApiKey);
        document.getElementById('saveApiKeyBtn').addEventListener('click', saveApiKey);
        document.getElementById('clearApiKeyBtn').addEventListener('click', clearApiKey);

        async function callAPI() {
            const prompt = promptInput.value.trim();
            const apiKey = CONFIG.API_KEY.trim();
            const isImageGenMode = imageGenMode.checked;
            
            if (!prompt && imageDataList.length === 0) return alert("è¯·è¾“å…¥å†…å®¹æˆ–ç²˜è´´å›¾ç‰‡");
            if (!apiKey || apiKey === "YOUR_API_KEY_HERE") return alert("è¯·è¾“å…¥æœ‰æ•ˆçš„ API Key");

            const genAI = new GoogleGenerativeAI(apiKey);
            
            let modelName;
            if (isImageGenMode) {
                modelName = imageModelName.value;
            } else if (imageDataList.length > 0) {
                modelName = visionModelName.value;
            } else {
                modelName = textModelName.value;
            }
            
            const generationConfig = {
                temperature: parseFloat(temperature.value),
                topP: parseFloat(topP.value),
                topK: 40,
                maxOutputTokens: 8192
            };
            
            if (isImageGenMode) {
                generationConfig.imageConfig = {
                    aspectRatio: aspectRatio.value,
                    imageSize: imageSize.value
                };
            }
            
            const model = genAI.getGenerativeModel({ 
                model: modelName,
                generationConfig: generationConfig
            });

            sendBtn.disabled = true;
            loader.classList.remove('hidden');
            responseOutput.classList.remove('italic', 'text-gray-400');
            responseOutput.innerText = "æ­£åœ¨å¤„ç†...";
            imageResponseContainer.classList.add('hidden');
            statusTag.innerText = "è¯·æ±‚ä¸­";
            statusTag.className = "text-xs px-2 py-1 rounded bg-blue-50 text-blue-600";

            try {
                let content;
                
                if (isImageGenMode) {
                    if (imageDataList.length > 0) {
                        if (prompt) {
                            content = imageDataList.map(imageData => ({
                                inlineData: { 
                                    data: imageData.split(',')[1], 
                                    mimeType: imageData.split(';')[0].split(':')[1] 
                                }
                            }));
                            content.push(`${prompt}ï¼Œä½¿ç”¨${aspectRatio.value}å®½é«˜æ¯”`);
                        } else {
                            content = imageDataList.map(imageData => ({
                                inlineData: { 
                                    data: imageData.split(',')[1], 
                                    mimeType: imageData.split(';')[0].split(':')[1] 
                                }
                            }));
                            content.push(`è¯·ç¾åŒ–è¿™å¼ å›¾ç‰‡ï¼Œä½¿ç”¨${aspectRatio.value}å®½é«˜æ¯”`);
                        }
                    } else {
                        content = `${prompt}ï¼Œä½¿ç”¨${aspectRatio.value}å®½é«˜æ¯”`;
                    }
                } else {
                    if (imageDataList.length > 0) {
                        content = imageDataList.map(imageData => ({
                            inlineData: { 
                                data: imageData.split(',')[1], 
                                mimeType: imageData.split(';')[0].split(':')[1] 
                                }
                        }));
                        content.push(prompt);
                    } else {
                        content = prompt;
                    }
                }
                
                const result = await model.generateContent(content);
                const response = await result.response;
                
                if (isImageGenMode) {
                    const imagePart = response.candidates[0]?.content?.parts.find(part => part.inlineData);
                    if (imagePart) {
                        const imageData = imagePart.inlineData.data;
                        
                        const byteCharacters = atob(imageData);
                        const byteNumbers = new Array(byteCharacters.length);
                        for (let i = 0; i < byteCharacters.length; i++) {
                            byteNumbers[i] = byteCharacters.charCodeAt(i);
                        }
                        const byteArray = new Uint8Array(byteNumbers);
                        const blob = new Blob([byteArray], { type: 'image/png' });
                        const blobUrl = URL.createObjectURL(blob);
                        
                        imageResponse.src = blobUrl;
                        imageResponse.onclick = () => {
                            openModal(blobUrl);
                        };
                        imageResponseContainer.classList.remove('hidden');
                        
                        try {
                            const saveResponse = await fetch('/save-image', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ 
                                    imageData: imageData,
                                    prompt: prompt,
                                    aspectRatio: aspectRatio.value,
                                    imageSize: imageSize.value
                                })
                            });
                            const saveResult = await saveResponse.json();
                            if (saveResult.success) {
                                responseOutput.innerText = `å›¾ç‰‡ç”ŸæˆæˆåŠŸï¼\nå·²ä¿å­˜åˆ°: ${saveResult.dateFolder}/${saveResult.fileName}\næç¤ºè¯æ–‡ä»¶: ${saveResult.txtFileName}`;
                            } else {
                                responseOutput.innerText = `å›¾ç‰‡ç”ŸæˆæˆåŠŸï¼\nä¿å­˜å¤±è´¥: ${saveResult.error}`;
                            }
                        } catch (saveError) {
                            console.error('ä¿å­˜å›¾ç‰‡å¤±è´¥:', saveError);
                            responseOutput.innerText = `å›¾ç‰‡ç”ŸæˆæˆåŠŸï¼\nä¿å­˜å¤±è´¥: ${saveError.message}`;
                        }
                    } else {
                        responseOutput.innerText = "æœªæ‰¾åˆ°ç”Ÿæˆçš„å›¾ç‰‡æ•°æ®ã€‚\n" + response.text();
                    }
                } else {
                    const text = response.text();
                    responseOutput.innerText = text;
                }
                
                statusTag.innerText = "æˆåŠŸ";
                statusTag.className = "text-xs px-2 py-1 rounded bg-green-50 text-green-600";
            } catch (error) {
                console.error(error);
                responseOutput.innerText = "å‘ç”Ÿé”™è¯¯: " + error.message;
                statusTag.innerText = "å¤±è´¥";
                statusTag.className = "text-xs px-2 py-1 rounded bg-red-50 text-red-600";
            } finally {
                sendBtn.disabled = false;
                loader.classList.add('hidden');
            }
        }

        sendBtn.addEventListener('click', callAPI);

        promptInput.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') callAPI();
        });
    </script>
</body>
</html>